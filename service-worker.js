const p=(t,e)=>e.some(n=>t instanceof n);let j,E;function R(){return j||(j=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function v(){return E||(E=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const w=new WeakMap,g=new WeakMap,m=new WeakMap;function O(t){const e=new Promise((n,s)=>{const a=()=>{t.removeEventListener("success",o),t.removeEventListener("error",r)},o=()=>{n(f(t.result)),a()},r=()=>{s(t.error),a()};t.addEventListener("success",o),t.addEventListener("error",r)});return m.set(e,t),e}function C(t){if(w.has(t))return;const e=new Promise((n,s)=>{const a=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",r),t.removeEventListener("abort",r)},o=()=>{n(),a()},r=()=>{s(t.error||new DOMException("AbortError","AbortError")),a()};t.addEventListener("complete",o),t.addEventListener("error",r),t.addEventListener("abort",r)});w.set(t,e)}let y={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return w.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function L(t){y=t(y)}function T(t){return v().includes(t)?function(...e){return t.apply(I(this),e),f(this.request)}:function(...e){return f(t.apply(I(this),e))}}function N(t){return typeof t=="function"?T(t):(t instanceof IDBTransaction&&C(t),p(t,R())?new Proxy(t,y):t)}function f(t){if(t instanceof IDBRequest)return O(t);if(g.has(t))return g.get(t);const e=N(t);return e!==t&&(g.set(t,e),m.set(e,t)),e}const I=t=>m.get(t);function W(t,e,{blocked:n,upgrade:s,blocking:a,terminated:o}={}){const r=indexedDB.open(t,e),u=f(r);return s&&r.addEventListener("upgradeneeded",i=>{s(f(r.result),i.oldVersion,i.newVersion,f(r.transaction),i)}),n&&r.addEventListener("blocked",i=>n(i.oldVersion,i.newVersion,i)),u.then(i=>{o&&i.addEventListener("close",()=>o()),a&&i.addEventListener("versionchange",d=>a(d.oldVersion,d.newVersion,d))}).catch(()=>{}),u}const k=["get","getKey","getAll","getAllKeys","count"],x=["put","add","delete","clear"],h=new Map;function S(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(h.get(e))return h.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,a=x.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(a||k.includes(n)))return;const o=async function(r,...u){const i=this.transaction(r,a?"readwrite":"readonly");let d=i.store;return s&&(d=d.index(u.shift())),(await Promise.all([d[n](...u),a&&i.done]))[0]};return h.set(e,o),o}L(t=>({...t,get:(e,n,s)=>S(e,n)||t.get(e,n,s),has:(e,n)=>!!S(e,n)||t.has(e,n)}));const F=["continue","continuePrimaryKey","advance"],B={},b=new WeakMap,M=new WeakMap,A={get(t,e){if(!F.includes(e))return t[e];let n=B[e];return n||(n=B[e]=function(...s){b.set(this,M.get(this)[e](...s))}),n}};async function*V(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,A);for(M.set(n,e),m.set(n,I(e));e;)yield n,e=await(b.get(n)||e.continue()),b.delete(n)}function P(t,e){return e===Symbol.asyncIterator&&p(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&p(t,[IDBIndex,IDBObjectStore])}L(t=>({...t,get(e,n,s){return P(e,n)?V:t.get(e,n,s)},has(e,n){return P(e,n)||t.has(e,n)}}));const $="yggy-editor-db",K=1;let l=null;async function D(){return l||(l=await W($,K,{upgrade(e){e.objectStoreNames.contains("dialogue")||e.createObjectStore("dialogue"),e.objectStoreNames.contains("choices")||e.createObjectStore("choices"),e.objectStoreNames.contains("characters")||e.createObjectStore("characters"),e.objectStoreNames.contains("images")||e.createObjectStore("images"),e.objectStoreNames.contains("backgrounds")||e.createObjectStore("backgrounds"),e.objectStoreNames.contains("frames")||e.createObjectStore("frames"),e.objectStoreNames.contains("meta")||e.createObjectStore("meta"),e.objectStoreNames.contains("uploadedImages")||e.createObjectStore("uploadedImages")}}),l)}function U(){self.addEventListener("install",t=>{console.log("Service worker installing"),t.waitUntil(G()),self.skipWaiting()}),self.addEventListener("activate",t=>{console.log("Service worker activating"),t.waitUntil(clients.claim())})}async function G(){const t=await D(),n=["dialogue","images","choices","characters","backgrounds","frames","meta"].map(async r=>{const i=await(await fetch(`/default-game-data/data/${r}.json`)).json();await t.put(r,i,"data")}),o=(await(await fetch("/default-game-data/images/list.json")).json()).map(async r=>{const i=await(await fetch(`/default-game-data/images/${r}`)).blob();await t.put("uploadedImages",i,r)});await Promise.all([...n,...o]),console.log("Database seeded with default game data.")}U();self.addEventListener("fetch",async t=>{const e=t,n=new URL(e.request.url);if(n.pathname.startsWith("/api/")){e.respondWith(q(e.request));return}if(n.pathname.startsWith("/game-data/")){e.respondWith(_(e.request));return}e.respondWith(fetch(e.request))});async function _(t){const e=new URL(t.url),n=await D(),s=e.pathname.match(/\/game-data\/data\/(.+)\.json$/);if(s){const o=s[1];try{const r=await n.get(o,"data");return c(r||{})}catch(r){return console.error(`Error getting ${o} data:`,r),c({error:`Failed to get ${o} data`},500)}}const a=e.pathname.match(/\/game-data\/images\/(.+)$/);if(a){const o=a[1];try{const r=await n.get("uploadedImages",o);return r?new Response(r,{headers:{"Content-Type":r.type}}):new Response("Image not found",{status:404})}catch(r){return console.error(`Error getting image ${o}:`,r),new Response("Failed to get image",{status:500})}}return new Response("Game data not found",{status:404})}async function q(t){console.debug("serving api request",t);const e=new URL(t.url),n=t.method,s=await D();if(n==="GET")switch(e.pathname){case"/api/get":{const a=e.searchParams.get("type");if(!a)return c({error:"Missing type parameter"},400);try{const o=await s.get(a,"data");return c(o||{})}catch(o){return console.error("Error getting data:",o),c({error:"Failed to get data"},500)}}case"/api/get-images":try{const a=await s.getAllKeys("uploadedImages");return c(a)}catch(a){return console.error("Error getting images:",a),c({error:"Failed to get images"},500)}case"/api/version":return new Response("1.0.0",{headers:{"Content-Type":"text/plain"}});default:return c({error:"Endpoint not found"},404)}else if(n==="POST")switch(e.pathname){case"/api/save":try{const a=await t.json(),{type:o,data:r}=a;return!o||!r?c({error:"Missing type or data"},400):(await s.put(o,r,"data"),new Response("OK"))}catch(a){return console.error("Error saving data:",a),c({error:"Failed to save data"},500)}case"/api/upload-image":try{const a=e.searchParams.get("filename");if(!a)return c({error:"Missing filename"},400);const o=await t.arrayBuffer();return await s.put("uploadedImages",o,a),new Response(a)}catch(a){return console.error("Error uploading image:",a),c({error:"Failed to upload image"},500)}default:return c({error:"Endpoint not found"},404)}return c({error:"Method not allowed"},405)}function c(t,e=200){return new Response(JSON.stringify(t),{status:e,headers:{"Content-Type":"application/json"}})}
