import"./modulepreload-polyfill-B5Qt9EMX.js";const T={currentDialogueID:null},v={doc:null,bg:null,charName:null,char1Img:null,char2Img:null,dialogueText:null,choicesDiv:null,continueInd:null};function pe(){const e=document.querySelector("iframe");v.doc=e?e.contentDocument:document,v.bg=v.doc.getElementById("background"),v.charName=v.doc.getElementById("character-name"),v.char1Img=v.doc.getElementById("character1"),v.char2Img=v.doc.getElementById("character2"),v.dialogueText=v.doc.querySelector("#dialogue-box .text"),v.choicesDiv=v.doc.getElementById("choices"),v.continueInd=v.doc.getElementById("continue-indicator")}const se=[];let re=!1;function le(e,i,a){re||be(),Array.isArray(i)||(i=[i]);for(const n of i)se.push({selector:e,eventName:n,handler:a})}function be(){v.doc.body.addEventListener("click",$.bind(null,"click")),v.doc.body.addEventListener("input",$.bind(null,"input")),v.doc.body.addEventListener("change",$.bind(null,"change")),v.doc.body.addEventListener("contextmenu",$.bind(null,"contextmenu")),v.doc.body.addEventListener("keyup",$.bind(null,"keyup")),v.doc.body.addEventListener("focusout",$.bind(null,"focusout")),v.doc.body.addEventListener("mouseover",$.bind(null,"mouseover")),v.doc.body.addEventListener("mousemove",$.bind(null,"mousemove")),v.doc.body.addEventListener("mouseout",$.bind(null,"mouseout")),re=!0}function $(e,i){const a=i.target;for(const n of se)n.eventName===e&&a.matches(n.selector)&&n.handler(i,a)}const f={dialogue:null,images:null,choices:null,characters:null,backgrounds:null,frames:null,meta:null};function h(e,i){const a=f[e];for(let n=0;n<a.length;n++)if(a[n].id===i)return a[n];return null}function Y(e,i,a){let n;const t=a==="left"?v.char1Img:v.char2Img;if(e===null){v.charName.classList.add("hidden"),t.classList.add("hidden");return}else n=h("characters",e),v.charName.classList.remove("hidden");if(i===null)t.classList.add("hidden");else{const c=h("frames",n.frames[i]),s=h("images",c.imageID);t.src=`/game-data/images/${s.filename}`,t.classList.remove("hidden")}}function ue(){const e=h("dialogue",T.currentDialogueID),i=h("backgrounds",e.backgroundID),a=h("images",i.imageID);v.bg.style.backgroundImage=`url(/game-data/images/${a.filename})`,v.bg.style.backgroundColor=i.bgColor,Y(e.character1ID,e.character1FrameIndex,"left"),Y(e.character2ID,e.character2FrameIndex,"right"),v.dialogueText.textContent=e.text,ve();let n=!0;for(const t of e.choices){const c=h("choices",t);Ie(c.text,t),c.text.length>0&&(n=!1)}if(e.ownerCharacterID!==null){const t=h("characters",e.ownerCharacterID);v.charName.textContent=t.name,v.charName.classList.remove("hidden")}else v.charName.classList.add("hidden");if(n){if(e.choices.length>1)throw new Error(`All ${e.choices.length} dialogue choices are hidden`);v.continueInd.classList.remove("hidden")}else v.continueInd.classList.add("hidden")}function ve(){v.choicesDiv.innerHTML=""}function Ie(e,i){const a=document.createElement("button");a.className="choice",a.type="button",a.textContent=e,a.dataset.id=i.toString(),e.length===0&&a.classList.add("hidden"),v.choicesDiv.append(a)}function De(){le("div#choices button.choice","click",i=>{const n=+i.target.dataset.id,t=h("choices",n);t.targetDialogueID!==null&&(T.currentDialogueID=t.targetDialogueID,ue())}),v.doc.getElementById("dialogue-box").addEventListener("click",e),window.addEventListener("keypress",e);function e(i){if(i instanceof KeyboardEvent&&i.code!=="Space"&&i.code!=="Enter")return;const a=Array.from(v.doc.querySelectorAll("#choices button.choice"));a.length!==1||!a[0].classList.contains("hidden")||(a[0].click(),i.preventDefault())}}function Q(e,i){Array.isArray(e)||(e=[e]);for(const a of e)a.disabled=i}function C(e){return document.querySelector(e)}function I(e){return document.createElement(e)}const D={btnBack:C("button#nav-back"),btnNext:C("button#nav-next"),btnPush:C("button#push"),btnPull:C("button#pull"),btnSave:C("button#save"),btnClear:C("button#clear"),dialogueTab:{dialogue:C("#dialogue-tab textarea.dialogue"),choices:C("#dialogue-tab div.choices"),characters:C("#dialogue-tab div.characters"),background:C("#dialogue-tab select.background")},charactersTab:{list:C("#characters-tab div.list")},backgroundsTab:{list:C("#backgrounds-tab div.list")},imagesTab:{list:C("#images-tab div.list"),previewSelect:C("#images-tab .image-file-preview-select"),previewImage:C("#images-tab #image-file-preview"),uploadFileName:C("#images-tab #upload input.name"),fileInput:C('#images-tab input[type="file"]'),uploadButton:C("#images-tab #upload button.submit")},tree:{list:C("#tree-tab > ul"),btnUndo:C("#tree-tab > div > button.undo")}};function ke(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var X,Z;function xe(){if(Z)return X;Z=1,n.notEqual=i,n.notOk=a,n.equal=e,n.ok=n,X=n;function e(t,c,s){n(t==c,s)}function i(t,c,s){n(t!=c,s)}function a(t,c){n(!t,c)}function n(t,c){if(!t)throw new Error(c||"AssertionError")}return X}var J,ee;function ye(){return ee||(ee=1,J=["onclick","ondblclick","onmousedown","onmouseup","onmouseover","onmousemove","onmouseout","onmouseenter","onmouseleave","ontouchcancel","ontouchend","ontouchmove","ontouchstart","ondragstart","ondrag","ondragenter","ondragleave","ondragover","ondrop","ondragend","onkeydown","onkeypress","onkeyup","onunload","onabort","onerror","onresize","onscroll","onselect","onchange","onsubmit","onreset","onfocus","onblur","oninput","onanimationend","onanimationiteration","onanimationstart","oncontextmenu","onfocusin","onfocusout"]),J}var G,te;function Ce(){if(te)return G;te=1;var e=ye(),i=e.length,a=1,n=3,t=8;G=c;function c(l,r){var p=l.nodeType,y=l.nodeName;p===a&&s(l,r),(p===n||p===t)&&r.nodeValue!==l.nodeValue&&(r.nodeValue=l.nodeValue),y==="INPUT"?u(l,r):y==="OPTION"?o(l,r):y==="TEXTAREA"&&d(l,r),m(l,r)}function s(l,r){for(var p=r.attributes,y=l.attributes,E=null,L=null,O=null,S=null,w=null,j=y.length-1;j>=0;--j)w=y[j],S=w.name,E=w.namespaceURI,L=w.value,E?(S=w.localName||S,O=r.getAttributeNS(E,S),O!==L&&r.setAttributeNS(E,S,L)):r.hasAttribute(S)?(O=r.getAttribute(S),O!==L&&(L==="null"||L==="undefined"?r.removeAttribute(S):r.setAttribute(S,L))):r.setAttribute(S,L);for(var z=p.length-1;z>=0;--z)w=p[z],w.specified!==!1&&(S=w.name,E=w.namespaceURI,E?(S=w.localName||S,l.hasAttributeNS(E,S)||r.removeAttributeNS(E,S)):l.hasAttributeNS(null,S)||r.removeAttribute(S))}function m(l,r){for(var p=0;p<i;p++){var y=e[p];l[y]?r[y]=l[y]:r[y]&&(r[y]=void 0)}}function o(l,r){k(l,r,"selected")}function u(l,r){var p=l.value,y=r.value;k(l,r,"checked"),k(l,r,"disabled"),l.indeterminate!==r.indeterminate&&(r.indeterminate=l.indeterminate),r.type!=="file"&&(p!==y&&(r.setAttribute("value",p),r.value=p),p==="null"&&(r.value="",r.removeAttribute("value")),l.hasAttributeNS(null,"value")?r.type==="range"&&(r.value=p):r.removeAttribute("value"))}function d(l,r){var p=l.value;if(p!==r.value&&(r.value=p),r.firstChild&&r.firstChild.nodeValue!==p){if(p===""&&r.firstChild.nodeValue===r.placeholder)return;r.firstChild.nodeValue=p}}function k(l,r,p){l[p]!==r[p]&&(r[p]=l[p],l[p]?r.setAttribute(p,""):r.removeAttribute(p))}return G}var K,ne;function Te(){if(ne)return K;ne=1;var e=xe(),i=Ce(),a=3;K=n;function n(o,u,d){return e.equal(typeof o,"object","nanomorph: oldTree should be an object"),e.equal(typeof u,"object","nanomorph: newTree should be an object"),d&&d.childrenOnly?(s(u,o),o):(e.notEqual(u.nodeType,11,"nanomorph: newTree should have one root node (which is not a DocumentFragment)"),t(u,o))}function t(o,u){return u?o?o.isSameNode&&o.isSameNode(u)?u:o.tagName!==u.tagName||c(o)!==c(u)?o:(i(o,u),s(o,u),u):null:o}function c(o){return o.dataset?o.dataset.nanomorphComponentId:void 0}function s(o,u){for(var d,k,l,r,p=0,y=0;d=u.childNodes[y],k=o.childNodes[y-p],!(!d&&!k);y++)if(!k)u.removeChild(d),y--;else if(!d)u.appendChild(k),p++;else if(m(k,d))l=t(k,d),l!==d&&(u.replaceChild(l,d),p++);else{r=null;for(var E=y;E<u.childNodes.length;E++)if(m(u.childNodes[E],k)){r=u.childNodes[E];break}r?(l=t(k,r),l!==r&&p++,u.insertBefore(l,d)):!k.id&&!d.id?(l=t(k,d),l!==d&&(u.replaceChild(l,d),p++)):(u.insertBefore(k,d),p++)}}function m(o,u){return o.id?o.id===u.id:o.isSameNode?o.isSameNode(u):o.tagName!==u.tagName?!1:o.type===a?o.nodeValue===u.nodeValue:!1}return K}var Se=Te();const P=ke(Se);function Ee(e){const i=D.dialogueTab.choices.cloneNode(),{choices:a}=e;i.innerHTML="";for(const c of a){const s=h("choices",c),m=I("div");m.className="choice",m.dataset.id=c.toString();const o=I("textarea");o.className="text",o.cols=30,o.placeholder="Choice text",o.value=s.text,m.append(o);const u=I("button");if(u.className="delete",u.type="button",u.textContent="X",u.title="Delete choice",m.append(u),s.targetDialogueID===null){const d=I("button");d.className="create-dialogue",d.type="button",d.textContent="+ Dialogue",d.title="Attach a new dialogue to this choice",m.append(d)}i.append(m)}const n=I("div"),t=I("button");t.className="create",t.type="button",t.textContent="+ Choice",t.title="Add choice",n.append(t),i.append(n),P(D.dialogueTab.choices,i)}function V(e,i,a){const n=I("select");n.className=e;for(const t of i){if(!t)continue;const c=I("option");c.value=t.value!==void 0?t.value:t.text.toLowerCase(),c.textContent=t.text,n.append(c)}return a!==void 0&&(n.value=a+""),n}function Le(e){const i=D.dialogueTab.characters.cloneNode(),a=h("characters",e.character1ID),n=ae(a,e.character1FrameIndex,e.ownerCharacterID);i.append(n);const t=h("characters",e.character2ID),c=ae(t,e.character2FrameIndex,e.ownerCharacterID);i.append(c),P(D.dialogueTab.characters,i)}function ae(e,i,a,n){const t=e===null?"none":e.id,c=I("div");c.className="character",c.dataset.id=t.toString();const s=f.characters.map(l=>({text:l.name,value:l.id.toString()}));s.unshift({text:"None"});const m=V("name",s,t);if(c.append(m),e===null)return c;const o=e.frames.map((l,r)=>({text:h("frames",l).name,value:r.toString()}));o.unshift({text:"None"});const u=V("frame",o,i);c.append(u);const d=I("label");d.className="owner",d.htmlFor="dialogue-owner-ch"+t,d.textContent="Talking:",c.append(d);const k=I("input");return k.className="owner",k.type="checkbox",k.checked=a===t,k.id="dialogue-owner-ch"+t,c.append(k),c}function we(e){const i=h("backgrounds",e.backgroundID);D.dialogueTab.background.innerHTML="";const a=f.backgrounds;for(const n of a){const t=I("option");t.value=n.id.toString(),t.textContent=n.name,D.dialogueTab.background.append(t)}D.dialogueTab.background.value=i.id.toString()}function Oe(){const e=h("dialogue",T.currentDialogueID);D.dialogueTab.dialogue.value=e.text,Ee(e),Le(e),we(e)}function $e(){const e=D.charactersTab.list.cloneNode(),i=f.characters;e.innerHTML="";const a=f.images.map(n=>({text:n.name,value:n.id.toString()}));for(const n of i){const t=I("div");t.className="character",t.dataset.id=n.id.toString(),e.append(t);const c=I("input");if(c.className="name",c.type="text",c.value=n.name,t.append(c),i.length>1){const o=I("button");o.className="delete",o.type="button",o.textContent="X",o.title="Delete character",t.append(o)}for(let o=0;o<n.frames.length;o++){const u=n.frames[o],d=h("frames",u),k=I("div");k.className="frame",k.dataset.id=d.id.toString(),t.append(k);let l;if(o===0)l=I("span"),l.textContent=d.name;else{l=I("input");const y=l;y.type="text",y.value=d.name,y.placeholder="Frame name"}l.className="name",k.append(l);const r=V("image",a,d.imageID);if(k.append(r),o===0)continue;const p=I("button");p.className="delete",p.type="button",p.textContent="X",k.append(p)}const s=I("div");s.className="frame",t.append(s);const m=I("button");m.className="create",m.type="button",m.textContent="+ Frame",s.append(m)}P(D.charactersTab.list,e)}function Ae(){const e=D.backgroundsTab.list.cloneNode(),i=f.backgrounds;e.innerHTML="";const a=f.images.map(n=>({text:n.name,value:n.id.toString()}));for(const n of i){const t=I("div");t.className="background",t.dataset.id=n.id.toString();const c=I("input");c.className="name",c.type="text",c.value=n.name,t.append(c);const s=V("image",a,n.imageID);t.append(s);const m=I("input");if(m.className="bg-color",m.type="text",m.value=n.bgColor,m.title="Color of the background behind image",t.append(m),i.length>1){const o=I("button");o.className="delete",o.type="button",o.textContent="X",o.title="Delete background",t.append(o)}e.append(t)}P(D.backgroundsTab.list,e)}function M(e,i){const a=I("button");return a.type="button",a.className=e,a.textContent=i,a}async function Fe(){const i=await(await fetch("/api/get-images")).json(),a=D.imagesTab.list.cloneNode(),n=f.images;a.innerHTML="";const t=i.map(m=>({text:m}));for(const m of n){const o=I("div");o.className="image",o.dataset.id=m.id.toString();const u=I("img");u.className="image-preview",u.src="/game-data/images/"+m.filename,o.append(u);const d=I("input");d.className="name",d.type="text",d.value=m.name,o.append(d);const k=V("image-file",t,m.filename);if(o.append(k),n.length>1){const l=M("delete","X");l.title="Delete image",o.append(l)}a.append(o)}const c=D.imagesTab.previewSelect.value||"none";t.unshift({text:"None"});const s=V("image-file-preview-select",t);D.imagesTab.previewSelect.replaceWith(s),i.indexOf(c)>-1?s.value=c:s.value="none",P(D.imagesTab.list,a)}const g={devMode:location.href.includes("8080"),history:[],currentHistoryIndex:-1,tree:{collapsed:{dialogue:[],choices:[]},linking:{dialogueID:null,srcDialogueID:null,choiceID:null,finalized:!1}}};let _;function Be(){_=D.tree.list.cloneNode();const e=f.dialogue[0];de(e,_),P(D.tree.list,_),Q(D.tree.btnUndo,!g.tree.linking.finalized||g.tree.linking.dialogueID===null||g.tree.linking.choiceID===null)}const ie="Click to toggle collapse";let Ne=0;function de(e,i){if(Ne++>5e3)return;const a=!!_.querySelector(`li.dialogue[data-id="${e.id}"]`),n=I("li");n.className="dialogue"+(a?" reference":""),n.dataset.id=e.id.toString(),T.currentDialogueID===e.id&&!a&&n.classList.add("active"),g.tree.collapsed.dialogue.indexOf(e.id)>-1&&n.classList.add("collapsed"),i.append(n);const t=I("div");t.className="content",n.append(t);const c=I("span");if(c.className="text",c.textContent=e.text,c.title=ie,t.append(c),e.character1ID!==null){const u=h("characters",e.character1ID),d=I("span");d.className="character",d.textContent=u.name,t.append(d)}if(e.character2ID!==null){const u=h("characters",e.character2ID),d=I("span");d.className="character",d.textContent=u.name,t.append(d)}if(a)return;const s=M("go-to","Go");s.title="Go to dialogue in preview",t.append(s);const m=M("link","Link");if(m.title="Link dialogue to choice",!g.tree.linking.finalized&&g.tree.linking.dialogueID===e.id&&m.classList.add("active"),t.append(m),e.choices.length===0)return;const o=I("ul");o.className="choices",n.append(o);for(const u of e.choices){const d=h("choices",u),k=d.text.length>0?d.text:"(cycle dialogue)",l=I("li");l.className="choice",l.dataset.id=u.toString(),g.tree.collapsed.choices.indexOf(d.id)>-1&&l.classList.add("collapsed"),d.text.length===0&&l.classList.add("cycle-dialogue"),o.append(l);const r=I("div");r.className="content",l.append(r);const p=I("span");p.className="text",p.textContent=k,p.title=ie,r.append(p);const y=M("link","Link");if(y.title="Link choice to dialogue",!g.tree.linking.finalized&&g.tree.linking.choiceID===d.id&&y.classList.add("active"),r.append(y),d.targetDialogueID===null){const O=M("create-dialogue","+ Dialogue");r.append(O);continue}else{const O=M("unlink","Unlink");O.title="Remove dialogue link",r.append(O)}const E=h("dialogue",d.targetDialogueID),L=I("ul");l.append(L),de(E,L)}}function F(){const e=performance.now(),a=document.querySelector(".tab.active").id.toLowerCase();if(a.indexOf("dialogue")>-1?Oe():a.indexOf("characters")>-1?$e():a.indexOf("tree")>-1?Be():a.indexOf("backgrounds")>-1?Ae():a.indexOf("images")>-1&&Fe(),Q(D.btnBack,g.currentHistoryIndex===0),Q(D.btnNext,g.currentHistoryIndex===g.history.length-1),g.devMode){const n=performance.now()-e;document.getElementById("update-time").textContent=`${n.toFixed(3)}ms`}}function He(){const e=g.currentHistoryIndex+1;e>=g.history.length||(T.currentDialogueID=g.history[e],g.currentHistoryIndex++)}function qe(){const e=g.currentHistoryIndex-1;e<0||(T.currentDialogueID=g.history[e],g.currentHistoryIndex--)}function ge(e){g.currentHistoryIndex<g.history.length-1&&(g.history.length=g.currentHistoryIndex+1),T.currentDialogueID=e,g.history.push(e),g.currentHistoryIndex++}function Me(){((i,a,n)=>{le(i,a,(t,c)=>{setTimeout(()=>{n(t,c)},0)})})("div#choices button.choice","click",i=>{ge(T.currentDialogueID),F()})}function x(){setTimeout(()=>{ue(),F()},0)}const fe=[];let me=!1;function b(e,i,a){me||Ve(),Array.isArray(i)||(i=[i]);for(const n of i)fe.push({selector:e,eventName:n,handler:a})}function Ve(){document.body.addEventListener("click",A.bind(null,"click")),document.body.addEventListener("input",A.bind(null,"input")),document.body.addEventListener("change",A.bind(null,"change")),document.body.addEventListener("contextmenu",A.bind(null,"contextmenu")),document.body.addEventListener("keyup",A.bind(null,"keyup")),document.body.addEventListener("focusout",A.bind(null,"focusout")),document.body.addEventListener("mouseover",A.bind(null,"mouseover")),document.body.addEventListener("mousemove",A.bind(null,"mousemove")),document.body.addEventListener("mouseout",A.bind(null,"mouseout")),me=!0}function A(e,i){const a=i.target;for(const n of fe)n.eventName===e&&a.matches(n.selector)&&n.handler(i,a);i.stopImmediatePropagation()}function R(e){switch(e){case"backgrounds":return f.backgrounds[0];case"images":return f.images[0];case"characters":return f.characters[0]}}function Pe(e){const i=h("choices",e);f.choices.splice(f.choices.indexOf(i),1);for(const n of f.dialogue)n.choices.indexOf(e)>-1&&n.choices.splice(n.choices.indexOf(e),1);const a=g.tree.collapsed.choices.indexOf(i.id);a>-1&&g.tree.collapsed.choices.splice(a,1)}function Re(e){const i=h("characters",e);f.characters.splice(f.characters.indexOf(i),1);const a=R("characters");for(const n of f.dialogue)n.character1ID===e&&(n.character1ID=a.id,n.character1FrameIndex=0),n.character2ID===e&&(n.character2ID=a.id,n.character2FrameIndex=0)}function Ue(e){const i=h("backgrounds",e);f.backgrounds.splice(f.backgrounds.indexOf(i),1);const a=f.backgrounds[0].id;for(const n of f.dialogue)n.backgroundID===e&&(n.backgroundID=a)}function _e(e){const i=h("images",e);f.images.splice(f.images.indexOf(i),1);const a=f.images[0].id;for(const n of f.backgrounds)n.imageID===e&&(n.imageID=a);for(const n of f.frames)n.imageID===e&&(n.imageID=a)}function je(e){const i=h("dialogue",e);f.dialogue.splice(f.dialogue.indexOf(i),1)}function ze(e){const i=h("frames",e),a=[];let n=!1;for(const t of f.characters){const c=t.frames.indexOf(e);if(c===0){n=!0;break}else c>0&&a.push(t)}if(!n){for(const t of a)t.frames.splice(t.frames.indexOf(e),1);f.frames.splice(f.frames.indexOf(i),1)}}const B={choice:Pe,character:Re,background:Ue,image:_e,dialogue:je,frame:ze},U={};(()=>{const e=Object.keys(f);e.splice(e.indexOf("meta"),1);for(const i of e)U[i]=[]})();function H(e){let i=Math.floor(Math.random()*9999999999);return U[e].indexOf(i)>-1&&(i=H(e)),U[e].push(i),i}function Xe(){const e=Object.keys(U);for(const i of e)for(const a of f[i])U[i].push(a.id)}function Je(e){return JSON.parse(JSON.stringify(e))}function q(e,i){return e===null||Number.isNaN(e)||typeof e!="number"?i:e}function Ge(e){console.log(e);const i={id:H("dialogue"),text:"Dialogue text",choices:[],backgroundID:q(e.backgroundID,R("backgrounds").id),character1ID:q(e.character1ID,R("characters").id),character1FrameIndex:q(e.character1FrameIndex,0),character2ID:q(e.character2ID,null),character2FrameIndex:q(e.character2FrameIndex,null),ownerCharacterID:q(e.ownerCharacterID,R("characters").id)};return f.dialogue.push(i),i}function Ke(){const e={id:H("choices"),text:"Choice text",targetDialogueID:null};return f.choices.push(e),e}function We(){const e=he(),i={id:H("characters"),name:"New Character",frames:[e.id]};return f.characters.push(i),i}function he(e){const i={id:H("frames"),name:e||"Default frame",imageID:R("images").id};return f.frames.push(i),i}function Qe(){const e={id:H("images"),name:"New Image",filename:""};return f.images.push(e),e}const N={dialogue:Ge,choice:Ke,character:We,frame:he,image:Qe};function Ye(){const e="#dialogue-tab";b(`${e} textarea.dialogue`,"input",(i,a)=>{const n=h("dialogue",T.currentDialogueID);n.text=a.value,x()}),b(`${e} div.choices textarea.text`,"input",(i,a)=>{const n=+a.closest("div.choice").dataset.id,t=h("choices",n);t.text=a.value,x()}),b(`${e} div.choices button.create`,"click",()=>{const i=h("dialogue",T.currentDialogueID),a=N.choice();i.choices.push(a.id),x()}),b(`${e} div.choices button.delete`,"click",(i,a)=>{const n=+a.closest("div.choice").dataset.id;B.choice(n),x()}),b(`${e} div.choices button.create-dialogue`,"click",(i,a)=>{const n=h("dialogue",T.currentDialogueID),t=+a.closest("div.choice").dataset.id,c=h("choices",t),s=N.dialogue(n);c.targetDialogueID=s.id,x()}),b(`${e} div.characters .character select.name`,"click",(i,a)=>{const n=a.closest("div.character").matches(":first-of-type"),t=h("dialogue",T.currentDialogueID),c=+a.closest("div.character").dataset.id,s=a.value;let m,o;if(s==="none"?(m=null,o=null):(m=+s,o=0),m!==null&&(n&&m===t.character2ID||!n&&m===t.character1ID)){const u=n?t.character1ID:t.character2ID;a.value=u===null?"none":u.toString();return}m!==null&&t.ownerCharacterID===null&&t.character1ID===null&&t.character2ID===null&&(t.ownerCharacterID=m),n?(t.character1ID=m,t.character1FrameIndex=o):(t.character2ID=m,t.character2FrameIndex=o),s==="none"&&c===t.ownerCharacterID&&(t.ownerCharacterID=null),s==="none"&&t.ownerCharacterID===null&&(t.character1ID!==null||t.character2ID!==null)&&(t.character1ID!==null?t.ownerCharacterID=t.character1ID:t.character2ID!==null&&(t.ownerCharacterID=t.character2ID)),x()}),b(`${e} div.characters .character select.frame`,"click",(i,a)=>{const n=a.closest("div.character").matches(":first-of-type"),t=h("dialogue",T.currentDialogueID),c=a.value;let s;c==="none"?s=null:s=+c,n?t.character1FrameIndex=s:t.character2FrameIndex=s,x()}),b(`${e} div.characters .character input.owner`,"change",(i,a)=>{const n=h("dialogue",T.currentDialogueID),t=a.closest(".character").dataset.id;n.ownerCharacterID=t==="none"?null:+t,x()}),b(`${e} select.background`,"click",(i,a)=>{const n=h("dialogue",T.currentDialogueID),t=+a.value;n.backgroundID=t,x()})}function Ze(){const e="#characters-tab";b(`${e} button.create`,"click",()=>{N.character(),F()}),b(`${e} div.character > button.delete`,"click",(i,a)=>{const n=+a.closest("div.character").dataset.id;B.character(n),x()}),b(`${e} div.character > input.name`,"input",(i,a)=>{const n=+a.closest("div.character").dataset.id,t=h("characters",n);t.name=a.value,x()}),b(`${e} div.frame > button.create`,"click",(i,a)=>{const n=+a.closest("div.character").dataset.id,t=h("characters",n),c=N.frame("New frame");t.frames.push(c.id),x()}),b(`${e} div.frame > input.name`,"input",(i,a)=>{const n=+a.closest("div.frame").dataset.id,t=h("frames",n);t.name=a.value,x()}),b(`${e} div.frame > select.image`,"change",(i,a)=>{const n=+a.closest("div.frame").dataset.id,t=+a.value,c=h("frames",n);c.imageID=t,x()}),b(`${e} div.frame > button.delete`,"click",(i,a)=>{const n=+a.closest("div.frame").dataset.id;B.frame(n),x()})}function et(){const e="#backgrounds-tab";b(`${e} button.create`,"click",()=>{const i=H("backgrounds");f.backgrounds.push({id:i,name:"New Background",imageID:f.images[0].id,bgColor:"#FFFFFF"}),F()}),b(`${e} .list button.delete`,"click",(i,a)=>{const n=+a.closest("div.background").dataset.id;B.background(n),x()}),b(`${e} .list input.name`,"input",(i,a)=>{const n=+a.closest("div.background").dataset.id,t=h("backgrounds",n);t.name=a.value,x()}),b(`${e} .list input.bg-color`,"change",(i,a)=>{const n=+a.closest("div.background").dataset.id,t=h("backgrounds",n);let c=a.value;c.indexOf("#")===-1&&(c="#"+c),t.bgColor=c,x()}),b(`${e} .list select.image`,"change",(i,a)=>{const n=+a.closest("div.background").dataset.id,t=+a.value,c=h("backgrounds",n);c.imageID=t,x()})}function tt(){const e="#images-tab";b(`${e} button.create`,"click",()=>{N.image(),F()}),b(`${e} .list button.delete`,"click",(n,t)=>{const c=+t.closest("div.image").dataset.id;B.image(c),x()}),b(`${e} .list input.name`,"input",(n,t)=>{const c=+t.closest("div.image").dataset.id,s=h("images",c);s.name=t.value,F()}),b(`${e} .list select.image-file`,"change",(n,t)=>{const c=+t.closest("div.image").dataset.id,s=h("images",c);s.filename=t.value,x()}),b(`${e} select.image-file-preview-select`,"change",(n,t)=>{let c=t.value;c==="none"?c="":c="/assets/images/"+c,D.imagesTab.previewImage.src=c}),b(`${e} #upload button.submit`,"click",async()=>{if(D.imagesTab.fileInput.files.length===0){i();return}const n=D.imagesTab.fileInput.files[0];let t=D.imagesTab.uploadFileName.value;t||(t=n.name),t=encodeURIComponent(t);const c="/api/upload-image?filename="+t,s=await fetch(c,{method:"POST",body:n.slice()}),m=await s.text();if(s.status!==200)console.log(s),i();else{a();const o=N.image();o.name=t.replace(".png",""),o.filename=m}F()});function i(){D.imagesTab.uploadButton.classList.add("error"),D.imagesTab.uploadButton.disabled=!0,setTimeout(()=>{D.imagesTab.uploadButton.classList.remove("error"),D.imagesTab.uploadButton.disabled=!1},1500)}function a(){D.imagesTab.uploadButton.classList.add("success"),D.imagesTab.uploadButton.disabled=!0,setTimeout(()=>{D.imagesTab.uploadButton.classList.remove("success"),D.imagesTab.uploadButton.disabled=!1},1500)}}function nt(){const e="#tree-tab";b(`${e} li > div.content > span.text`,"click",(n,t)=>{const c=t.closest("li"),s=c.classList.toggle("collapsed"),m=+c.dataset.id,u=/dialogue/i.test(c.className)?g.tree.collapsed.dialogue:g.tree.collapsed.choices;s?u.push(m):u.splice(u.indexOf(m),1)}),b(`${e} li.dialogue > div.content > button.go-to`,"click",(n,t)=>{const c=+t.closest("li.dialogue").dataset.id;T.currentDialogueID!==c&&(T.currentDialogueID=c,ge(c),x())}),b(`${e} li.dialogue.reference > div.content > span.text`,"mouseover",(n,t)=>{const c=+t.closest("li.dialogue").dataset.id;C(`${e} li.dialogue:not(.reference)[data-id="${c}"]`).classList.add("highlight")}),b(`${e} li.dialogue.reference > div.content > span.text`,"mouseout",(n,t)=>{C(`${e} li.dialogue:not(.reference).highlight`).classList.remove("highlight")}),b(`${e} li.dialogue > div.content > button.link`,"click",(n,t)=>{g.tree.linking.finalized&&i();const c=+t.closest("li.dialogue").dataset.id;g.tree.linking.dialogueID===c?g.tree.linking.dialogueID=null:g.tree.linking.dialogueID=c,a()}),b(`${e} li.choice > div.content > button.link`,"click",(n,t)=>{g.tree.linking.finalized&&i();const c=+t.closest("li.choice").dataset.id,s=h("choices",c);g.tree.linking.choiceID===c?(g.tree.linking.choiceID=null,g.tree.linking.srcDialogueID=null):(g.tree.linking.choiceID=c,s.targetDialogueID!==null&&(g.tree.linking.srcDialogueID=s.targetDialogueID)),a()});function i(){g.tree.linking.choiceID=null,g.tree.linking.dialogueID=null,g.tree.linking.srcDialogueID=null}function a(){if(g.tree.linking.choiceID===null||g.tree.linking.dialogueID===null){g.tree.linking.finalized=!1,F();return}const n=h("choices",g.tree.linking.choiceID);n.targetDialogueID=g.tree.linking.dialogueID,g.tree.linking.finalized=!0,x()}b(`${e} > div > button.undo`,"click",(n,t)=>{const c=Object.assign({},g.tree.linking);g.tree.linking.dialogueID=c.srcDialogueID,g.tree.linking.srcDialogueID=c.dialogueID;const s=h("choices",c.choiceID);s.targetDialogueID=c.srcDialogueID,x()}),b(`${e} li.choice > div.content > button.unlink`,"click",(n,t)=>{const c=+t.closest("li.choice").dataset.id,s=h("choices",c);s.targetDialogueID=null,x()}),b(`${e} li.choice > div.content > button.create-dialogue`,"click",(n,t)=>{const c=+t.closest("li.dialogue").dataset.id,s=+t.closest("li.choice").dataset.id,m=h("dialogue",c),o=h("choices",s),u=N.dialogue(m);o.targetDialogueID=u.id,x()})}function at(){b("#utilities-tab button.remove-orphans","click",()=>{const i=f.dialogue.map(n=>n.id);i.splice(0,1);for(const n of f.choices){const t=i.indexOf(n.targetDialogueID);t>-1&&i.splice(t,1)}for(const n of i)B.dialogue(n);const a=f.choices.map(n=>n.id);for(const n of f.dialogue)for(const t of n.choices){const c=a.indexOf(t);c>-1&&a.splice(c,1)}for(const n of a)B.choice(n)})}function it(){Ye(),Ze(),et(),tt(),nt(),at(),b("button#nav-back","click",()=>{qe(),x()}),b("button#nav-next","click",()=>{He(),x()}),b("button#game-size","click",(a,n)=>{const t=document.querySelector("iframe"),c=document.getElementById("editor");c.classList.contains("hidden")?(t.style.width="",c.classList.remove("hidden"),n.innerHTML="&gt;"):(t.style.width="100%",c.classList.add("hidden"),n.innerHTML="&lt;")}),b("button#push","click",async(a,n)=>{n.classList.add("active"),n.disabled=!0,n.textContent="Pushing...";const t=Object.keys(f);for(const c of t)await fetch("/api/save",{method:"post",body:JSON.stringify({type:c,data:f[c]})});n.classList.remove("active"),n.textContent="Pushed",setTimeout(()=>{n.disabled=!1,n.textContent="Push changes"},750)}),b("button#save","click",async(a,n)=>{i(n)});let e=!1;b("button#clear","click",async(a,n)=>{e=!0;const t=localStorage.getItem("editor-opened-tab");localStorage.clear(),t&&localStorage.setItem("editor-opened-tab",t),n.textContent="Cleared",setTimeout(()=>{location.reload()},500)}),setInterval(i.bind(null,D.btnSave,!0),15e3),window.addEventListener("beforeunload",i.bind(null,D.btnSave,!0));function i(a,n){if(n&&e)return;const t=Object.keys(f);for(const c of t)localStorage.setItem("editor-"+c,JSON.stringify(f[c]));a.disabled=!0,a.textContent="Saved",setTimeout(()=>{a.disabled=!1,a.textContent="Save"},2500)}}const ct=document.getElementById("tabs-list");function ot(){const e=localStorage.getItem("editor-opened-tab");e&&setTimeout(()=>{const i=C(`#tabs-list span.link[data-target="${e}"]`);i&&i.click()},0),b("#tabs-list span.link","click",(i,a)=>{document.querySelector(".tab.active").classList.remove("active"),ct.querySelector(".active").classList.remove("active");const n=a.dataset.target+"-tab";document.getElementById(n).classList.add("active"),a.classList.add("active"),localStorage.setItem("editor-opened-tab",a.dataset.target),F()})}async function st(){const e=Object.keys(f),i=[];for(const n of e){console.log("fetching game data",n);const t=fetch(`/game-data/data/${n}.json`);i.push(t)}const a=await Promise.all(i);for(const n of a){const t=n.url.match(/game-data\/data\/(.+)\.json$/)[1],c=await n.json();f[t]=c}}async function rt(){const e=Object.keys(f),i={};let a=!1;for(const t of e){const c=localStorage.getItem("editor-"+t);c||(a=!0),i[t]=JSON.parse(c)}const n=g.devMode;a||n?(console.log("Allowing game to load data..."),await st()):(Object.assign(f,i),console.log("Loaded data from local storage.")),console.log("Game data:",f),window.data=f}function ce(e,i){const a=Je(e),n=i+1;switch(n){case 2:{for(const t of a.dialogue)t.ownerCharacterID=t.characterID,oe(t,"characterID","character1ID"),oe(t,"characterFrameIndex","character1FrameIndex"),t.character2ID=null,t.character2FrameIndex=null;break}case 1:{if(a.meta={version:1},a.frames)break;a.frames=[];let t=0;for(const c of a.characters){const s={id:t++,name:"Default frame",imageID:c.imageID};a.frames.push(s),c.frames=[s.id],delete c.imageID}for(const c of a.dialogue)c.characterFrameIndex=0;break}}return a.meta.version=n,a}function oe(e,i,a){const n=e[i];delete e[i],e[a]=n}const W=2;function lt(e){const i=ut(e);if(i>W)throw new Error("Game Data version is newer than expected. Please go back in time and try again.");if(i===W)return e;let a=ce(e,i);for(;a.meta.version<W;)a=ce(a,a.meta.version);return a}function ut(e){return e.meta?e.meta.version:0}const dt=["editor-opened-tab"];function gt(){const e={},i=[];for(let t=0;t<localStorage.length;t++){const c=localStorage.key(t);dt.indexOf(c)>-1||i.push(c)}if(i.length===0)return;for(const t of i)try{const c=JSON.parse(localStorage.getItem(t)),s=t.replace("editor-","");e[s]=c}catch{return}const a=lt(e);if(console.log("Migrated local data to new version. Saving..."),a===e)return;const n=Object.keys(a);for(const t of n){const c="editor-"+t,s=JSON.stringify(a[t]);localStorage.setItem(c,s)}console.log("Saved.")}window.addEventListener("load",async()=>{if(window!==window.top)return;gt(),await rt(),Xe(),T.currentDialogueID=0,g.history.push(0),g.currentHistoryIndex=0,pe(),Me(),De(),it(),ot(),x();const e=await(await fetch("/api/version")).text();document.getElementById("version").textContent="v"+e,g.devMode&&document.getElementById("update-time").classList.remove("hidden")});
