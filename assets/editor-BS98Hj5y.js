import{g as b,b as m,s as C,c as le,d as ue,n as H,l as de,e as fe,i as ge,a as me}from"./events-DROwv771.js";function K(e,c){Array.isArray(e)||(e=[e]);for(const n of e)n.disabled=c}function y(e){return document.querySelector(e)}function v(e){return document.createElement(e)}const I={btnBack:y("button#nav-back"),btnNext:y("button#nav-next"),btnPush:y("button#push"),btnPull:y("button#pull"),btnSave:y("button#save"),btnClear:y("button#clear"),dialogueTab:{dialogue:y("#dialogue-tab textarea.dialogue"),choices:y("#dialogue-tab div.choices"),characters:y("#dialogue-tab div.characters"),background:y("#dialogue-tab select.background")},charactersTab:{list:y("#characters-tab div.list")},backgroundsTab:{list:y("#backgrounds-tab div.list")},imagesTab:{list:y("#images-tab div.list"),previewSelect:y("#images-tab .image-file-preview-select"),previewImage:y("#images-tab #image-file-preview"),uploadFileName:y("#images-tab #upload input.name"),fileInput:y('#images-tab input[type="file"]'),uploadButton:y("#images-tab #upload button.submit")},tree:{list:y("#tree-tab > ul"),btnUndo:y("#tree-tab > div > button.undo")}};function he(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var z,W;function pe(){if(W)return z;W=1,a.notEqual=c,a.notOk=n,a.equal=e,a.ok=a,z=a;function e(t,i,r){a(t==i,r)}function c(t,i,r){a(t!=i,r)}function n(t,i){a(!t,i)}function a(t,i){if(!t)throw new Error(i||"AssertionError")}return z}var j,Q;function be(){return Q||(Q=1,j=["onclick","ondblclick","onmousedown","onmouseup","onmouseover","onmousemove","onmouseout","onmouseenter","onmouseleave","ontouchcancel","ontouchend","ontouchmove","ontouchstart","ondragstart","ondrag","ondragenter","ondragleave","ondragover","ondrop","ondragend","onkeydown","onkeypress","onkeyup","onunload","onabort","onerror","onresize","onscroll","onselect","onchange","onsubmit","onreset","onfocus","onblur","oninput","onanimationend","onanimationiteration","onanimationstart","oncontextmenu","onfocusin","onfocusout"]),j}var X,Y;function ve(){if(Y)return X;Y=1;var e=be(),c=e.length,n=1,a=3,t=8;X=i;function i(l,s){var h=l.nodeType,x=l.nodeName;h===n&&r(l,s),(h===a||h===t)&&s.nodeValue!==l.nodeValue&&(s.nodeValue=l.nodeValue),x==="INPUT"?u(l,s):x==="OPTION"?o(l,s):x==="TEXTAREA"&&d(l,s),g(l,s)}function r(l,s){for(var h=s.attributes,x=l.attributes,S=null,w=null,O=null,T=null,E=null,U=x.length-1;U>=0;--U)E=x[U],T=E.name,S=E.namespaceURI,w=E.value,S?(T=E.localName||T,O=s.getAttributeNS(S,T),O!==w&&s.setAttributeNS(S,T,w)):s.hasAttribute(T)?(O=s.getAttribute(T),O!==w&&(w==="null"||w==="undefined"?s.removeAttribute(T):s.setAttribute(T,w))):s.setAttribute(T,w);for(var _=h.length-1;_>=0;--_)E=h[_],E.specified!==!1&&(T=E.name,S=E.namespaceURI,S?(T=E.localName||T,l.hasAttributeNS(S,T)||s.removeAttributeNS(S,T)):l.hasAttributeNS(null,T)||s.removeAttribute(T))}function g(l,s){for(var h=0;h<c;h++){var x=e[h];l[x]?s[x]=l[x]:s[x]&&(s[x]=void 0)}}function o(l,s){D(l,s,"selected")}function u(l,s){var h=l.value,x=s.value;D(l,s,"checked"),D(l,s,"disabled"),l.indeterminate!==s.indeterminate&&(s.indeterminate=l.indeterminate),s.type!=="file"&&(h!==x&&(s.setAttribute("value",h),s.value=h),h==="null"&&(s.value="",s.removeAttribute("value")),l.hasAttributeNS(null,"value")?s.type==="range"&&(s.value=h):s.removeAttribute("value"))}function d(l,s){var h=l.value;if(h!==s.value&&(s.value=h),s.firstChild&&s.firstChild.nodeValue!==h){if(h===""&&s.firstChild.nodeValue===s.placeholder)return;s.firstChild.nodeValue=h}}function D(l,s,h){l[h]!==s[h]&&(s[h]=l[h],l[h]?s.setAttribute(h,""):s.removeAttribute(h))}return X}var G,Z;function Ie(){if(Z)return G;Z=1;var e=pe(),c=ve(),n=3;G=a;function a(o,u,d){return e.equal(typeof o,"object","nanomorph: oldTree should be an object"),e.equal(typeof u,"object","nanomorph: newTree should be an object"),d&&d.childrenOnly?(r(u,o),o):(e.notEqual(u.nodeType,11,"nanomorph: newTree should have one root node (which is not a DocumentFragment)"),t(u,o))}function t(o,u){return u?o?o.isSameNode&&o.isSameNode(u)?u:o.tagName!==u.tagName||i(o)!==i(u)?o:(c(o,u),r(o,u),u):null:o}function i(o){return o.dataset?o.dataset.nanomorphComponentId:void 0}function r(o,u){for(var d,D,l,s,h=0,x=0;d=u.childNodes[x],D=o.childNodes[x-h],!(!d&&!D);x++)if(!D)u.removeChild(d),x--;else if(!d)u.appendChild(D),h++;else if(g(D,d))l=t(D,d),l!==d&&(u.replaceChild(l,d),h++);else{s=null;for(var S=x;S<u.childNodes.length;S++)if(g(u.childNodes[S],D)){s=u.childNodes[S];break}s?(l=t(D,s),l!==s&&h++,u.insertBefore(l,d)):!D.id&&!d.id?(l=t(D,d),l!==d&&(u.replaceChild(l,d),h++)):(u.insertBefore(D,d),h++)}}function g(o,u){return o.id?o.id===u.id:o.isSameNode?o.isSameNode(u):o.tagName!==u.tagName?!1:o.type===n?o.nodeValue===u.nodeValue:!1}return G}var De=Ie();const N=he(De);function ke(e){const c=I.dialogueTab.choices.cloneNode(),{choices:n}=e;c.innerHTML="";for(const i of n){const r=b("choices",i),g=v("div");g.className="choice",g.dataset.id=i.toString();const o=v("textarea");o.className="text",o.cols=30,o.placeholder="Choice text",o.value=r.text,g.append(o);const u=v("button");if(u.className="delete",u.type="button",u.textContent="X",u.title="Delete choice",g.append(u),r.targetDialogueID===null){const d=v("button");d.className="create-dialogue",d.type="button",d.textContent="+ Dialogue",d.title="Attach a new dialogue to this choice",g.append(d)}c.append(g)}const a=v("div"),t=v("button");t.className="create",t.type="button",t.textContent="+ Choice",t.title="Add choice",a.append(t),c.append(a),N(I.dialogueTab.choices,c)}function q(e,c,n){const a=v("select");a.className=e;for(const t of c){if(!t)continue;const i=v("option");i.value=t.value!==void 0?t.value:t.text.toLowerCase(),i.textContent=t.text,a.append(i)}return n!==void 0&&(a.value=n+""),a}function xe(e){const c=I.dialogueTab.characters.cloneNode(),n=b("characters",e.character1ID),a=ee(n,e.character1FrameIndex,e.ownerCharacterID);c.append(a);const t=b("characters",e.character2ID),i=ee(t,e.character2FrameIndex,e.ownerCharacterID);c.append(i),N(I.dialogueTab.characters,c)}function ee(e,c,n,a){const t=e===null?"none":e.id,i=v("div");i.className="character",i.dataset.id=t.toString();const r=m.characters.map(l=>({text:l.name,value:l.id.toString()}));r.unshift({text:"None"});const g=q("name",r,t);if(i.append(g),e===null)return i;const o=e.frames.map((l,s)=>({text:b("frames",l).name,value:s.toString()}));o.unshift({text:"None"});const u=q("frame",o,c);i.append(u);const d=v("label");d.className="owner",d.htmlFor="dialogue-owner-ch"+t,d.textContent="Talking:",i.append(d);const D=v("input");return D.className="owner",D.type="checkbox",D.checked=n===t,D.id="dialogue-owner-ch"+t,i.append(D),i}function ye(e){const c=b("backgrounds",e.backgroundID);I.dialogueTab.background.innerHTML="";const n=m.backgrounds;for(const a of n){const t=v("option");t.value=a.id.toString(),t.textContent=a.name,I.dialogueTab.background.append(t)}I.dialogueTab.background.value=c.id.toString()}function Te(){const e=b("dialogue",C.currentDialogueID);I.dialogueTab.dialogue.value=e.text,ke(e),xe(e),ye(e)}function Ce(){const e=I.charactersTab.list.cloneNode(),c=m.characters;e.innerHTML="";const n=m.images.map(a=>({text:a.name,value:a.id.toString()}));for(const a of c){const t=v("div");t.className="character",t.dataset.id=a.id.toString(),e.append(t);const i=v("input");if(i.className="name",i.type="text",i.value=a.name,t.append(i),c.length>1){const o=v("button");o.className="delete",o.type="button",o.textContent="X",o.title="Delete character",t.append(o)}for(let o=0;o<a.frames.length;o++){const u=a.frames[o],d=b("frames",u),D=v("div");D.className="frame",D.dataset.id=d.id.toString(),t.append(D);let l;if(o===0)l=v("span"),l.textContent=d.name;else{l=v("input");const x=l;x.type="text",x.value=d.name,x.placeholder="Frame name"}l.className="name",D.append(l);const s=q("image",n,d.imageID);if(D.append(s),o===0)continue;const h=v("button");h.className="delete",h.type="button",h.textContent="X",D.append(h)}const r=v("div");r.className="frame",t.append(r);const g=v("button");g.className="create",g.type="button",g.textContent="+ Frame",r.append(g)}N(I.charactersTab.list,e)}function Se(){const e=I.backgroundsTab.list.cloneNode(),c=m.backgrounds;e.innerHTML="";const n=m.images.map(a=>({text:a.name,value:a.id.toString()}));for(const a of c){const t=v("div");t.className="background",t.dataset.id=a.id.toString();const i=v("input");i.className="name",i.type="text",i.value=a.name,t.append(i);const r=q("image",n,a.imageID);t.append(r);const g=v("input");if(g.className="bg-color",g.type="text",g.value=a.bgColor,g.title="Color of the background behind image",t.append(g),c.length>1){const o=v("button");o.className="delete",o.type="button",o.textContent="X",o.title="Delete background",t.append(o)}e.append(t)}N(I.backgroundsTab.list,e)}function M(e,c){const n=v("button");return n.type="button",n.className=e,n.textContent=c,n}async function we(){const c=await(await fetch("/api/get-images")).json(),n=I.imagesTab.list.cloneNode(),a=m.images;n.innerHTML="";const t=c.map(g=>({text:g}));for(const g of a){const o=v("div");o.className="image",o.dataset.id=g.id.toString();const u=v("img");u.className="image-preview",u.src="/game-data/images/"+g.filename,o.append(u);const d=v("input");d.className="name",d.type="text",d.value=g.name,o.append(d);const D=q("image-file",t,g.filename);if(o.append(D),a.length>1){const l=M("delete","X");l.title="Delete image",o.append(l)}n.append(o)}const i=I.imagesTab.previewSelect.value||"none";t.unshift({text:"None"});const r=q("image-file-preview-select",t);I.imagesTab.previewSelect.replaceWith(r),c.indexOf(i)>-1?r.value=i:r.value="none",N(I.imagesTab.list,n)}const f={devMode:location.href.includes("8080"),history:[],currentHistoryIndex:-1,tree:{collapsed:{dialogue:[],choices:[]},linking:{dialogueID:null,srcDialogueID:null,choiceID:null,finalized:!1}}};let P;function Ee(){P=I.tree.list.cloneNode();const e=m.dialogue[0];ie(e,P),N(I.tree.list,P),K(I.tree.btnUndo,!f.tree.linking.finalized||f.tree.linking.dialogueID===null||f.tree.linking.choiceID===null)}const te="Click to toggle collapse";let Oe=0;function ie(e,c){if(Oe++>5e3)return;const n=!!P.querySelector(`li.dialogue[data-id="${e.id}"]`),a=v("li");a.className="dialogue"+(n?" reference":""),a.dataset.id=e.id.toString(),C.currentDialogueID===e.id&&!n&&a.classList.add("active"),f.tree.collapsed.dialogue.indexOf(e.id)>-1&&a.classList.add("collapsed"),c.append(a);const t=v("div");t.className="content",a.append(t);const i=v("span");if(i.className="text",i.textContent=e.text,i.title=te,t.append(i),e.character1ID!==null){const u=b("characters",e.character1ID),d=v("span");d.className="character",d.textContent=u.name,t.append(d)}if(e.character2ID!==null){const u=b("characters",e.character2ID),d=v("span");d.className="character",d.textContent=u.name,t.append(d)}if(n)return;const r=M("go-to","Go");r.title="Go to dialogue in preview",t.append(r);const g=M("link","Link");if(g.title="Link dialogue to choice",!f.tree.linking.finalized&&f.tree.linking.dialogueID===e.id&&g.classList.add("active"),t.append(g),e.choices.length===0)return;const o=v("ul");o.className="choices",a.append(o);for(const u of e.choices){const d=b("choices",u),D=d.text.length>0?d.text:"(cycle dialogue)",l=v("li");l.className="choice",l.dataset.id=u.toString(),f.tree.collapsed.choices.indexOf(d.id)>-1&&l.classList.add("collapsed"),d.text.length===0&&l.classList.add("cycle-dialogue"),o.append(l);const s=v("div");s.className="content",l.append(s);const h=v("span");h.className="text",h.textContent=D,h.title=te,s.append(h);const x=M("link","Link");if(x.title="Link choice to dialogue",!f.tree.linking.finalized&&f.tree.linking.choiceID===d.id&&x.classList.add("active"),s.append(x),d.targetDialogueID===null){const O=M("create-dialogue","+ Dialogue");s.append(O);continue}else{const O=M("unlink","Unlink");O.title="Remove dialogue link",s.append(O)}const S=b("dialogue",d.targetDialogueID),w=v("ul");l.append(w),ie(S,w)}}function $(){const e=performance.now(),n=document.querySelector(".tab.active").id.toLowerCase();if(n.indexOf("dialogue")>-1?Te():n.indexOf("characters")>-1?Ce():n.indexOf("tree")>-1?Ee():n.indexOf("backgrounds")>-1?Se():n.indexOf("images")>-1&&we(),K(I.btnBack,f.currentHistoryIndex===0),K(I.btnNext,f.currentHistoryIndex===f.history.length-1),f.devMode){const a=performance.now()-e;document.getElementById("update-time").textContent=`${a.toFixed(3)}ms`}}function Le(){const e=f.currentHistoryIndex+1;e>=f.history.length||(C.currentDialogueID=f.history[e],f.currentHistoryIndex++)}function $e(){const e=f.currentHistoryIndex-1;e<0||(C.currentDialogueID=f.history[e],f.currentHistoryIndex--)}function ce(e){f.currentHistoryIndex<f.history.length-1&&(f.history.length=f.currentHistoryIndex+1),C.currentDialogueID=e,f.history.push(e),f.currentHistoryIndex++}function Fe(){((c,n,a)=>{le(c,n,(t,i)=>{setTimeout(()=>{a(t,i)},0)})})("div#choices button.choice","click",c=>{ce(C.currentDialogueID),$()})}function k(){setTimeout(()=>{ue(),$()},0)}const oe=[];let se=!1;function p(e,c,n){se||Ae(),Array.isArray(c)||(c=[c]);for(const a of c)oe.push({selector:e,eventName:a,handler:n})}function Ae(){document.body.addEventListener("click",L.bind(null,"click")),document.body.addEventListener("input",L.bind(null,"input")),document.body.addEventListener("change",L.bind(null,"change")),document.body.addEventListener("contextmenu",L.bind(null,"contextmenu")),document.body.addEventListener("keyup",L.bind(null,"keyup")),document.body.addEventListener("focusout",L.bind(null,"focusout")),document.body.addEventListener("mouseover",L.bind(null,"mouseover")),document.body.addEventListener("mousemove",L.bind(null,"mousemove")),document.body.addEventListener("mouseout",L.bind(null,"mouseout")),se=!0}function L(e,c){const n=c.target;for(const a of oe)a.eventName===e&&n.matches(a.selector)&&a.handler(c,n);c.stopImmediatePropagation()}function V(e){switch(e){case"backgrounds":return m.backgrounds[0];case"images":return m.images[0];case"characters":return m.characters[0]}}function Be(e){const c=b("choices",e);m.choices.splice(m.choices.indexOf(c),1);for(const a of m.dialogue)a.choices.indexOf(e)>-1&&a.choices.splice(a.choices.indexOf(e),1);const n=f.tree.collapsed.choices.indexOf(c.id);n>-1&&f.tree.collapsed.choices.splice(n,1)}function He(e){const c=b("characters",e);m.characters.splice(m.characters.indexOf(c),1);const n=V("characters");for(const a of m.dialogue)a.character1ID===e&&(a.character1ID=n.id,a.character1FrameIndex=0),a.character2ID===e&&(a.character2ID=n.id,a.character2FrameIndex=0)}function Me(e){const c=b("backgrounds",e);m.backgrounds.splice(m.backgrounds.indexOf(c),1);const n=m.backgrounds[0].id;for(const a of m.dialogue)a.backgroundID===e&&(a.backgroundID=n)}function qe(e){const c=b("images",e);m.images.splice(m.images.indexOf(c),1);const n=m.images[0].id;for(const a of m.backgrounds)a.imageID===e&&(a.imageID=n);for(const a of m.frames)a.imageID===e&&(a.imageID=n)}function Ne(e){const c=b("dialogue",e);m.dialogue.splice(m.dialogue.indexOf(c),1)}function Ve(e){const c=b("frames",e),n=[];let a=!1;for(const t of m.characters){const i=t.frames.indexOf(e);if(i===0){a=!0;break}else i>0&&n.push(t)}if(!a){for(const t of n)t.frames.splice(t.frames.indexOf(e),1);m.frames.splice(m.frames.indexOf(c),1)}}const F={choice:Be,character:He,background:Me,image:qe,dialogue:Ne,frame:Ve},R={};(()=>{const e=Object.keys(m);e.splice(e.indexOf("meta"),1);for(const c of e)R[c]=[]})();function B(e){let c=Math.floor(Math.random()*9999999999);return R[e].indexOf(c)>-1&&(c=B(e)),R[e].push(c),c}function Re(){const e=Object.keys(R);for(const c of e)for(const n of m[c])R[c].push(n.id)}function Pe(e){console.log(e);const c={id:B("dialogue"),text:"Dialogue text",choices:[],backgroundID:H(e.backgroundID,V("backgrounds").id),character1ID:H(e.character1ID,V("characters").id),character1FrameIndex:H(e.character1FrameIndex,0),character2ID:H(e.character2ID,null),character2FrameIndex:H(e.character2FrameIndex,null),ownerCharacterID:H(e.ownerCharacterID,V("characters").id)};return m.dialogue.push(c),c}function Ue(){const e={id:B("choices"),text:"Choice text",targetDialogueID:null};return m.choices.push(e),e}function _e(){const e=re(),c={id:B("characters"),name:"New Character",frames:[e.id]};return m.characters.push(c),c}function re(e){const c={id:B("frames"),name:e||"Default frame",imageID:V("images").id};return m.frames.push(c),c}function ze(){const e={id:B("images"),name:"New Image",filename:""};return m.images.push(e),e}const A={dialogue:Pe,choice:Ue,character:_e,frame:re,image:ze};function je(){const e="#dialogue-tab";p(`${e} textarea.dialogue`,"input",(c,n)=>{const a=b("dialogue",C.currentDialogueID);a.text=n.value,k()}),p(`${e} div.choices textarea.text`,"input",(c,n)=>{const a=+n.closest("div.choice").dataset.id,t=b("choices",a);t.text=n.value,k()}),p(`${e} div.choices button.create`,"click",()=>{const c=b("dialogue",C.currentDialogueID),n=A.choice();c.choices.push(n.id),k()}),p(`${e} div.choices button.delete`,"click",(c,n)=>{const a=+n.closest("div.choice").dataset.id;F.choice(a),k()}),p(`${e} div.choices button.create-dialogue`,"click",(c,n)=>{const a=b("dialogue",C.currentDialogueID),t=+n.closest("div.choice").dataset.id,i=b("choices",t),r=A.dialogue(a);i.targetDialogueID=r.id,k()}),p(`${e} div.characters .character select.name`,"click",(c,n)=>{const a=n.closest("div.character").matches(":first-of-type"),t=b("dialogue",C.currentDialogueID),i=+n.closest("div.character").dataset.id,r=n.value;let g,o;if(r==="none"?(g=null,o=null):(g=+r,o=0),g!==null&&(a&&g===t.character2ID||!a&&g===t.character1ID)){const u=a?t.character1ID:t.character2ID;n.value=u===null?"none":u.toString();return}g!==null&&t.ownerCharacterID===null&&t.character1ID===null&&t.character2ID===null&&(t.ownerCharacterID=g),a?(t.character1ID=g,t.character1FrameIndex=o):(t.character2ID=g,t.character2FrameIndex=o),r==="none"&&i===t.ownerCharacterID&&(t.ownerCharacterID=null),r==="none"&&t.ownerCharacterID===null&&(t.character1ID!==null||t.character2ID!==null)&&(t.character1ID!==null?t.ownerCharacterID=t.character1ID:t.character2ID!==null&&(t.ownerCharacterID=t.character2ID)),k()}),p(`${e} div.characters .character select.frame`,"click",(c,n)=>{const a=n.closest("div.character").matches(":first-of-type"),t=b("dialogue",C.currentDialogueID),i=n.value;let r;i==="none"?r=null:r=+i,a?t.character1FrameIndex=r:t.character2FrameIndex=r,k()}),p(`${e} div.characters .character input.owner`,"change",(c,n)=>{const a=b("dialogue",C.currentDialogueID),t=n.closest(".character").dataset.id;a.ownerCharacterID=t==="none"?null:+t,k()}),p(`${e} select.background`,"click",(c,n)=>{const a=b("dialogue",C.currentDialogueID),t=+n.value;a.backgroundID=t,k()})}function Xe(){const e="#characters-tab";p(`${e} button.create`,"click",()=>{A.character(),$()}),p(`${e} div.character > button.delete`,"click",(c,n)=>{const a=+n.closest("div.character").dataset.id;F.character(a),k()}),p(`${e} div.character > input.name`,"input",(c,n)=>{const a=+n.closest("div.character").dataset.id,t=b("characters",a);t.name=n.value,k()}),p(`${e} div.frame > button.create`,"click",(c,n)=>{const a=+n.closest("div.character").dataset.id,t=b("characters",a),i=A.frame("New frame");t.frames.push(i.id),k()}),p(`${e} div.frame > input.name`,"input",(c,n)=>{const a=+n.closest("div.frame").dataset.id,t=b("frames",a);t.name=n.value,k()}),p(`${e} div.frame > select.image`,"change",(c,n)=>{const a=+n.closest("div.frame").dataset.id,t=+n.value,i=b("frames",a);i.imageID=t,k()}),p(`${e} div.frame > button.delete`,"click",(c,n)=>{const a=+n.closest("div.frame").dataset.id;F.frame(a),k()})}function Ge(){const e="#backgrounds-tab";p(`${e} button.create`,"click",()=>{const c=B("backgrounds");m.backgrounds.push({id:c,name:"New Background",imageID:m.images[0].id,bgColor:"#FFFFFF"}),$()}),p(`${e} .list button.delete`,"click",(c,n)=>{const a=+n.closest("div.background").dataset.id;F.background(a),k()}),p(`${e} .list input.name`,"input",(c,n)=>{const a=+n.closest("div.background").dataset.id,t=b("backgrounds",a);t.name=n.value,k()}),p(`${e} .list input.bg-color`,"change",(c,n)=>{const a=+n.closest("div.background").dataset.id,t=b("backgrounds",a);let i=n.value;i.indexOf("#")===-1&&(i="#"+i),t.bgColor=i,k()}),p(`${e} .list select.image`,"change",(c,n)=>{const a=+n.closest("div.background").dataset.id,t=+n.value,i=b("backgrounds",a);i.imageID=t,k()})}function Je(){const e="#images-tab";p(`${e} button.create`,"click",()=>{A.image(),$()}),p(`${e} .list button.delete`,"click",(a,t)=>{const i=+t.closest("div.image").dataset.id;F.image(i),k()}),p(`${e} .list input.name`,"input",(a,t)=>{const i=+t.closest("div.image").dataset.id,r=b("images",i);r.name=t.value,$()}),p(`${e} .list select.image-file`,"change",(a,t)=>{const i=+t.closest("div.image").dataset.id,r=b("images",i);r.filename=t.value,k()}),p(`${e} select.image-file-preview-select`,"change",(a,t)=>{let i=t.value;i==="none"?i="":i="/assets/images/"+i,I.imagesTab.previewImage.src=i}),p(`${e} #upload button.submit`,"click",async()=>{if(I.imagesTab.fileInput.files.length===0){c();return}const a=I.imagesTab.fileInput.files[0];let t=I.imagesTab.uploadFileName.value;t||(t=a.name),t=encodeURIComponent(t);const i="/api/upload-image?filename="+t,r=await fetch(i,{method:"POST",body:a.slice()}),g=await r.text();if(r.status!==200)console.log(r),c();else{n();const o=A.image();o.name=t.replace(".png",""),o.filename=g}$()});function c(){I.imagesTab.uploadButton.classList.add("error"),I.imagesTab.uploadButton.disabled=!0,setTimeout(()=>{I.imagesTab.uploadButton.classList.remove("error"),I.imagesTab.uploadButton.disabled=!1},1500)}function n(){I.imagesTab.uploadButton.classList.add("success"),I.imagesTab.uploadButton.disabled=!0,setTimeout(()=>{I.imagesTab.uploadButton.classList.remove("success"),I.imagesTab.uploadButton.disabled=!1},1500)}}function Ke(){const e="#tree-tab";p(`${e} li > div.content > span.text`,"click",(a,t)=>{const i=t.closest("li"),r=i.classList.toggle("collapsed"),g=+i.dataset.id,u=/dialogue/i.test(i.className)?f.tree.collapsed.dialogue:f.tree.collapsed.choices;r?u.push(g):u.splice(u.indexOf(g),1)}),p(`${e} li.dialogue > div.content > button.go-to`,"click",(a,t)=>{const i=+t.closest("li.dialogue").dataset.id;C.currentDialogueID!==i&&(C.currentDialogueID=i,ce(i),k())}),p(`${e} li.dialogue.reference > div.content > span.text`,"mouseover",(a,t)=>{const i=+t.closest("li.dialogue").dataset.id;y(`${e} li.dialogue:not(.reference)[data-id="${i}"]`).classList.add("highlight")}),p(`${e} li.dialogue.reference > div.content > span.text`,"mouseout",(a,t)=>{y(`${e} li.dialogue:not(.reference).highlight`).classList.remove("highlight")}),p(`${e} li.dialogue > div.content > button.link`,"click",(a,t)=>{f.tree.linking.finalized&&c();const i=+t.closest("li.dialogue").dataset.id;f.tree.linking.dialogueID===i?f.tree.linking.dialogueID=null:f.tree.linking.dialogueID=i,n()}),p(`${e} li.choice > div.content > button.link`,"click",(a,t)=>{f.tree.linking.finalized&&c();const i=+t.closest("li.choice").dataset.id,r=b("choices",i);f.tree.linking.choiceID===i?(f.tree.linking.choiceID=null,f.tree.linking.srcDialogueID=null):(f.tree.linking.choiceID=i,r.targetDialogueID!==null&&(f.tree.linking.srcDialogueID=r.targetDialogueID)),n()});function c(){f.tree.linking.choiceID=null,f.tree.linking.dialogueID=null,f.tree.linking.srcDialogueID=null}function n(){if(f.tree.linking.choiceID===null||f.tree.linking.dialogueID===null){f.tree.linking.finalized=!1,$();return}const a=b("choices",f.tree.linking.choiceID);a.targetDialogueID=f.tree.linking.dialogueID,f.tree.linking.finalized=!0,k()}p(`${e} > div > button.undo`,"click",(a,t)=>{const i=Object.assign({},f.tree.linking);f.tree.linking.dialogueID=i.srcDialogueID,f.tree.linking.srcDialogueID=i.dialogueID;const r=b("choices",i.choiceID);r.targetDialogueID=i.srcDialogueID,k()}),p(`${e} li.choice > div.content > button.unlink`,"click",(a,t)=>{const i=+t.closest("li.choice").dataset.id,r=b("choices",i);r.targetDialogueID=null,k()}),p(`${e} li.choice > div.content > button.create-dialogue`,"click",(a,t)=>{const i=+t.closest("li.dialogue").dataset.id,r=+t.closest("li.choice").dataset.id,g=b("dialogue",i),o=b("choices",r),u=A.dialogue(g);o.targetDialogueID=u.id,k()})}function We(){p("#utilities-tab button.remove-orphans","click",()=>{const c=m.dialogue.map(a=>a.id);c.splice(0,1);for(const a of m.choices){const t=c.indexOf(a.targetDialogueID);t>-1&&c.splice(t,1)}for(const a of c)F.dialogue(a);const n=m.choices.map(a=>a.id);for(const a of m.dialogue)for(const t of a.choices){const i=n.indexOf(t);i>-1&&n.splice(i,1)}for(const a of n)F.choice(a)})}function Qe(){je(),Xe(),Ge(),Je(),Ke(),We(),p("button#nav-back","click",()=>{$e(),k()}),p("button#nav-next","click",()=>{Le(),k()}),p("button#game-size","click",(n,a)=>{const t=document.querySelector("iframe"),i=document.getElementById("editor");i.classList.contains("hidden")?(t.style.width="",i.classList.remove("hidden"),a.innerHTML="&gt;"):(t.style.width="100%",i.classList.add("hidden"),a.innerHTML="&lt;")}),p("button#push","click",async(n,a)=>{a.classList.add("active"),a.disabled=!0,a.textContent="Pushing...";const t=Object.keys(m);for(const i of t)await fetch("/api/save",{method:"post",body:JSON.stringify({type:i,data:m[i]})});a.classList.remove("active"),a.textContent="Pushed",setTimeout(()=>{a.disabled=!1,a.textContent="Push changes"},750)}),p("button#save","click",async(n,a)=>{c(a)});let e=!1;p("button#clear","click",async(n,a)=>{e=!0;const t=localStorage.getItem("editor-opened-tab");localStorage.clear(),t&&localStorage.setItem("editor-opened-tab",t),a.textContent="Cleared",setTimeout(()=>{location.reload()},500)}),setInterval(c.bind(null,I.btnSave,!0),15e3),window.addEventListener("beforeunload",c.bind(null,I.btnSave,!0));function c(n,a){if(a&&e)return;const t=Object.keys(m);for(const i of t)localStorage.setItem("editor-"+i,JSON.stringify(m[i]));n.disabled=!0,n.textContent="Saved",setTimeout(()=>{n.disabled=!1,n.textContent="Save"},2500)}}const Ye=document.getElementById("tabs-list");function Ze(){const e=localStorage.getItem("editor-opened-tab");e&&setTimeout(()=>{const c=y(`#tabs-list span.link[data-target="${e}"]`);c&&c.click()},0),p("#tabs-list span.link","click",(c,n)=>{document.querySelector(".tab.active").classList.remove("active"),Ye.querySelector(".active").classList.remove("active");const a=n.dataset.target+"-tab";document.getElementById(a).classList.add("active"),n.classList.add("active"),localStorage.setItem("editor-opened-tab",n.dataset.target),$()})}async function et(){const e=Object.keys(m),c={};let n=!1;for(const t of e){const i=localStorage.getItem("editor-"+t);i||(n=!0),c[t]=JSON.parse(i)}const a=f.devMode;n||a?(console.log("Allowing game to load data..."),await de()):(Object.assign(m,c),console.log("Loaded data from local storage.")),console.log("Game data:",m),window.data=m}function ae(e,c){const n=fe(e),a=c+1;switch(a){case 2:{for(const t of n.dialogue)t.ownerCharacterID=t.characterID,ne(t,"characterID","character1ID"),ne(t,"characterFrameIndex","character1FrameIndex"),t.character2ID=null,t.character2FrameIndex=null;break}case 1:{if(n.meta={version:1},n.frames)break;n.frames=[];let t=0;for(const i of n.characters){const r={id:t++,name:"Default frame",imageID:i.imageID};n.frames.push(r),i.frames=[r.id],delete i.imageID}for(const i of n.dialogue)i.characterFrameIndex=0;break}}return n.meta.version=a,n}function ne(e,c,n){const a=e[c];delete e[c],e[n]=a}const J=2;function tt(e){const c=at(e);if(c>J)throw new Error("Game Data version is newer than expected. Please go back in time and try again.");if(c===J)return e;let n=ae(e,c);for(;n.meta.version<J;)n=ae(n,n.meta.version);return n}function at(e){return e.meta?e.meta.version:0}const nt=["editor-opened-tab"];function it(){const e={},c=[];for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);nt.indexOf(i)>-1||c.push(i)}if(c.length===0)return;for(const t of c)try{const i=JSON.parse(localStorage.getItem(t)),r=t.replace("editor-","");e[r]=i}catch{return}const n=tt(e);if(console.log("Migrated local data to new version. Saving..."),n===e)return;const a=Object.keys(n);for(const t of a){const i="editor-"+t,r=JSON.stringify(n[t]);localStorage.setItem(i,r)}console.log("Saved.")}window.addEventListener("load",async()=>{if(window!==window.top)return;it(),await et(),Re(),C.currentDialogueID=0,f.history.push(0),f.currentHistoryIndex=0,ge(),Fe(),me(),Qe(),Ze(),k();const e=await(await fetch("/api/version")).text();document.getElementById("version").textContent="v"+e,f.devMode&&document.getElementById("update-time").classList.remove("hidden")});
