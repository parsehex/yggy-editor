import{g as b,b as m,s as w,c as ge,d as he,n as N,l as me,e as pe,f as be,i as ve,a as Ie}from"./assets/events-BvDii-8u.js";function K(e,i){Array.isArray(e)||(e=[e]);for(const a of e)a.disabled=i}function y(e){return document.querySelector(e)}function v(e){return document.createElement(e)}const I={btnBack:y("button#nav-back"),btnNext:y("button#nav-next"),btnPush:y("button#push"),btnPull:y("button#pull"),btnSave:y("button#save"),btnClear:y("button#clear"),dialogueTab:{dialogue:y("#dialogue-tab textarea.dialogue"),choices:y("#dialogue-tab div.choices"),characters:y("#dialogue-tab div.characters"),background:y("#dialogue-tab select.background")},charactersTab:{list:y("#characters-tab div.list")},backgroundsTab:{list:y("#backgrounds-tab div.list")},imagesTab:{list:y("#images-tab div.list"),previewSelect:y("#images-tab .image-file-preview-select"),previewImage:y("#images-tab #image-file-preview"),uploadFileName:y("#images-tab #upload input.name"),fileInput:y('#images-tab input[type="file"]'),uploadButton:y("#images-tab #upload button.submit")},tree:{list:y("#tree-tab > ul"),btnUndo:y("#tree-tab > div > button.undo")}};function De(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var z,Y;function ke(){if(Y)return z;Y=1,n.notEqual=i,n.notOk=a,n.equal=e,n.ok=n,z=n;function e(t,c,o){n(t==c,o)}function i(t,c,o){n(t!=c,o)}function a(t,c){n(!t,c)}function n(t,c){if(!t)throw new Error(c||"AssertionError")}return z}var U,Z;function xe(){return Z||(Z=1,U=["onclick","ondblclick","onmousedown","onmouseup","onmouseover","onmousemove","onmouseout","onmouseenter","onmouseleave","ontouchcancel","ontouchend","ontouchmove","ontouchstart","ondragstart","ondrag","ondragenter","ondragleave","ondragover","ondrop","ondragend","onkeydown","onkeypress","onkeyup","onunload","onabort","onerror","onresize","onscroll","onselect","onchange","onsubmit","onreset","onfocus","onblur","oninput","onanimationend","onanimationiteration","onanimationstart","oncontextmenu","onfocusin","onfocusout"]),U}var G,ee;function ye(){if(ee)return G;ee=1;var e=xe(),i=e.length,a=1,n=3,t=8;G=c;function c(l,s){var h=l.nodeType,D=l.nodeName;h===a&&o(l,s),(h===n||h===t)&&s.nodeValue!==l.nodeValue&&(s.nodeValue=l.nodeValue),D==="INPUT"?u(l,s):D==="OPTION"?r(l,s):D==="TEXTAREA"&&d(l,s),g(l,s)}function o(l,s){for(var h=s.attributes,D=l.attributes,S=null,C=null,O=null,T=null,E=null,_=D.length-1;_>=0;--_)E=D[_],T=E.name,S=E.namespaceURI,C=E.value,S?(T=E.localName||T,O=s.getAttributeNS(S,T),O!==C&&s.setAttributeNS(S,T,C)):s.hasAttribute(T)?(O=s.getAttribute(T),O!==C&&(C==="null"||C==="undefined"?s.removeAttribute(T):s.setAttribute(T,C))):s.setAttribute(T,C);for(var j=h.length-1;j>=0;--j)E=h[j],E.specified!==!1&&(T=E.name,S=E.namespaceURI,S?(T=E.localName||T,l.hasAttributeNS(S,T)||s.removeAttributeNS(S,T)):l.hasAttributeNS(null,T)||s.removeAttribute(T))}function g(l,s){for(var h=0;h<i;h++){var D=e[h];l[D]?s[D]=l[D]:s[D]&&(s[D]=void 0)}}function r(l,s){x(l,s,"selected")}function u(l,s){var h=l.value,D=s.value;x(l,s,"checked"),x(l,s,"disabled"),l.indeterminate!==s.indeterminate&&(s.indeterminate=l.indeterminate),s.type!=="file"&&(h!==D&&(s.setAttribute("value",h),s.value=h),h==="null"&&(s.value="",s.removeAttribute("value")),l.hasAttributeNS(null,"value")?s.type==="range"&&(s.value=h):s.removeAttribute("value"))}function d(l,s){var h=l.value;if(h!==s.value&&(s.value=h),s.firstChild&&s.firstChild.nodeValue!==h){if(h===""&&s.firstChild.nodeValue===s.placeholder)return;s.firstChild.nodeValue=h}}function x(l,s,h){l[h]!==s[h]&&(s[h]=l[h],l[h]?s.setAttribute(h,""):s.removeAttribute(h))}return G}var X,te;function we(){if(te)return X;te=1;var e=ke(),i=ye(),a=3;X=n;function n(r,u,d){return e.equal(typeof r,"object","nanomorph: oldTree should be an object"),e.equal(typeof u,"object","nanomorph: newTree should be an object"),d&&d.childrenOnly?(o(u,r),r):(e.notEqual(u.nodeType,11,"nanomorph: newTree should have one root node (which is not a DocumentFragment)"),t(u,r))}function t(r,u){return u?r?r.isSameNode&&r.isSameNode(u)?u:r.tagName!==u.tagName||c(r)!==c(u)?r:(i(r,u),o(r,u),u):null:r}function c(r){return r.dataset?r.dataset.nanomorphComponentId:void 0}function o(r,u){for(var d,x,l,s,h=0,D=0;d=u.childNodes[D],x=r.childNodes[D-h],!(!d&&!x);D++)if(!x)u.removeChild(d),D--;else if(!d)u.appendChild(x),h++;else if(g(x,d))l=t(x,d),l!==d&&(u.replaceChild(l,d),h++);else{s=null;for(var S=D;S<u.childNodes.length;S++)if(g(u.childNodes[S],x)){s=u.childNodes[S];break}s?(l=t(x,s),l!==s&&h++,u.insertBefore(l,d)):!x.id&&!d.id?(l=t(x,d),l!==d&&(u.replaceChild(l,d),h++)):(u.insertBefore(x,d),h++)}}function g(r,u){return r.id?r.id===u.id:r.isSameNode?r.isSameNode(u):r.tagName!==u.tagName?!1:r.type===a?r.nodeValue===u.nodeValue:!1}return X}var Te=we();const V=De(Te);function Se(e){const i=I.dialogueTab.choices.cloneNode(),{choices:a}=e;i.innerHTML="";for(const c of a){const o=b("choices",c),g=v("div");g.className="choice",g.dataset.id=c.toString();const r=v("textarea");r.className="text",r.cols=30,r.placeholder="Choice text",r.value=o.text,g.append(r);const u=v("button");if(u.className="delete",u.type="button",u.textContent="X",u.title="Delete choice",g.append(u),o.targetDialogueID===null){const d=v("button");d.className="create-dialogue",d.type="button",d.textContent="+ Dialogue",d.title="Attach a new dialogue to this choice",g.append(d)}else{const d=v("button");d.className="go-to-dialogue",d.type="button",d.textContent="Go",d.title="Go to linked dialogue",g.append(d)}i.append(g)}const n=v("div"),t=v("button");t.className="create",t.type="button",t.textContent="+ Choice",t.title="Add choice",n.append(t),i.append(n),V(I.dialogueTab.choices,i)}function H(e,i,a){const n=v("select");n.className=e;for(const t of i){if(!t)continue;const c=v("option");c.value=t.value!==void 0?t.value:t.text.toLowerCase(),c.textContent=t.text,n.append(c)}return a!==void 0&&(n.value=a+""),n}function Ce(e,i){const a=v("span");return a.className=e,a.textContent=i,a}function Ee(e){const i=I.dialogueTab.characters.cloneNode(),a=b("characters",e.character1ID),n=ne("1",a,e.character1FrameIndex,e.ownerCharacterID);i.append(n);const t=b("characters",e.character2ID),c=ne("2",t,e.character2FrameIndex,e.ownerCharacterID);i.append(c),V(I.dialogueTab.characters,i)}function ne(e,i,a,n,t){const c=i===null?"none":i.id,o=v("div");o.className="character",o.dataset.id=c.toString();const g=m.characters.map(h=>({text:h.name,value:h.id.toString()}));g.unshift({text:"None"});const r=Ce("","Character "+e+":"),u=H("name",g,c);if(o.append(r),o.append(u),i===null)return o;const d=i.frames.map((h,D)=>({text:b("frames",h).name,value:D.toString()}));d.unshift({text:"None"});const x=H("frame",d,a);o.append(x);const l=v("label");l.className="owner",l.htmlFor="dialogue-owner-ch"+c,l.textContent="Talking:",o.append(l);const s=v("input");return s.className="owner",s.type="checkbox",s.checked=n===c,s.id="dialogue-owner-ch"+c,o.append(s),o}function Oe(e){const i=b("backgrounds",e.backgroundID);I.dialogueTab.background.innerHTML="";const a=m.backgrounds;for(const n of a){const t=v("option");t.value=n.id.toString(),t.textContent=n.name,I.dialogueTab.background.append(t)}I.dialogueTab.background.value=i.id.toString()}function Le(){const e=b("dialogue",w.currentDialogueID);I.dialogueTab.dialogue.value=e.text,Se(e),Ee(e),Oe(e)}function $e(){const e=I.charactersTab.list.cloneNode(),i=m.characters;e.innerHTML="";const a=m.images.map(n=>({text:n.name,value:n.id.toString()}));for(const n of i){const t=v("div");t.className="character",t.dataset.id=n.id.toString(),e.append(t);const c=v("input");if(c.className="name",c.type="text",c.value=n.name,t.append(c),i.length>1){const r=v("button");r.className="delete",r.type="button",r.textContent="X",r.title="Delete character",t.append(r)}for(let r=0;r<n.frames.length;r++){const u=n.frames[r],d=b("frames",u),x=v("div");x.className="frame",x.dataset.id=d.id.toString(),t.append(x);let l;if(r===0)l=v("span"),l.textContent=d.name;else{l=v("input");const D=l;D.type="text",D.value=d.name,D.placeholder="Frame name"}l.className="name",x.append(l);const s=H("image",a,d.imageID);if(x.append(s),r===0)continue;const h=v("button");h.className="delete",h.type="button",h.textContent="X",x.append(h)}const o=v("div");o.className="frame",t.append(o);const g=v("button");g.className="create",g.type="button",g.textContent="+ Frame",o.append(g)}V(I.charactersTab.list,e)}function Ae(){const e=I.backgroundsTab.list.cloneNode(),i=m.backgrounds;e.innerHTML="";const a=m.images.map(n=>({text:n.name,value:n.id.toString()}));for(const n of i){const t=v("div");t.className="background",t.dataset.id=n.id.toString();const c=v("input");c.className="name",c.type="text",c.value=n.name,t.append(c);const o=H("image",a,n.imageID);t.append(o);const g=v("input");if(g.className="bg-color",g.type="text",g.value=n.bgColor,g.title="Color of the background behind image",t.append(g),i.length>1){const r=v("button");r.className="delete",r.type="button",r.textContent="X",r.title="Delete background",t.append(r)}e.append(t)}V(I.backgroundsTab.list,e)}function M(e,i){const a=v("button");return a.type="button",a.className=e,a.textContent=i,a}async function Fe(){const i=await(await fetch("/api/get-images")).json(),a=I.imagesTab.list.cloneNode(),n=m.images;a.innerHTML="";const t=i.map(g=>({text:g}));for(const g of n){const r=v("div");r.className="image",r.dataset.id=g.id.toString();const u=v("img");u.className="image-preview",u.src="/game-data/images/"+g.filename,r.append(u);const d=v("input");d.className="name",d.type="text",d.value=g.name,r.append(d);const x=H("image-file",t,g.filename);if(r.append(x),n.length>1){const l=M("delete","X");l.title="Delete image",r.append(l)}a.append(r)}const c=I.imagesTab.previewSelect.value||"none";t.unshift({text:"None"});const o=H("image-file-preview-select",t);I.imagesTab.previewSelect.replaceWith(o),i.indexOf(c)>-1?o.value=c:o.value="none",V(I.imagesTab.list,a)}const f={devMode:location.href.includes("8080"),history:[],currentHistoryIndex:-1,tree:{collapsed:{dialogue:[],choices:[]},linking:{dialogueID:null,srcDialogueID:null,choiceID:null,finalized:!1}}};let W;function Be(){W=I.tree.list.cloneNode();const e=m.dialogue[0];re(e,W),V(I.tree.list,W),K(I.tree.btnUndo,!f.tree.linking.finalized||f.tree.linking.dialogueID===null||f.tree.linking.choiceID===null)}const ae="Click to toggle collapse";let Ne=0;function re(e,i){if(Ne++>5e3)return;const a=!!W.querySelector(`li.dialogue[data-id="${e.id}"]`),n=v("li");n.className="dialogue"+(a?" reference":""),n.dataset.id=e.id.toString(),w.currentDialogueID===e.id&&!a&&n.classList.add("active"),f.tree.collapsed.dialogue.indexOf(e.id)>-1&&n.classList.add("collapsed"),i.append(n);const t=v("div");t.className="content",n.append(t);const c=v("span");if(c.className="text",c.textContent=e.text,c.title=ae,t.append(c),e.character1ID!==null){const u=b("characters",e.character1ID),d=v("span");d.className="character",d.textContent=u.name,t.append(d)}if(e.character2ID!==null){const u=b("characters",e.character2ID),d=v("span");d.className="character",d.textContent=u.name,t.append(d)}if(a)return;const o=M("go-to","Go");o.title="Go to dialogue in preview",t.append(o);const g=M("link","Link");if(g.title="Link dialogue to choice",!f.tree.linking.finalized&&f.tree.linking.dialogueID===e.id&&g.classList.add("active"),t.append(g),e.choices.length===0)return;const r=v("ul");r.className="choices",n.append(r);for(const u of e.choices){const d=b("choices",u),x=d.text.length>0?d.text:"(cycle dialogue)",l=v("li");l.className="choice",l.dataset.id=u.toString(),f.tree.collapsed.choices.indexOf(d.id)>-1&&l.classList.add("collapsed"),d.text.length===0&&l.classList.add("cycle-dialogue"),r.append(l);const s=v("div");s.className="content",l.append(s);const h=v("span");h.className="text",h.textContent=x,h.title=ae,s.append(h);const D=M("link","Link");if(D.title="Link choice to dialogue",!f.tree.linking.finalized&&f.tree.linking.choiceID===d.id&&D.classList.add("active"),s.append(D),d.targetDialogueID===null){const O=M("create-dialogue","+ Dialogue");s.append(O);continue}else{const O=M("unlink","Unlink");O.title="Remove dialogue link",s.append(O)}const S=b("dialogue",d.targetDialogueID),C=v("ul");l.append(C),re(S,C)}}function $(){const e=performance.now(),a=document.querySelector(".tab.active").id.toLowerCase();if(a.indexOf("dialogue")>-1?Le():a.indexOf("characters")>-1?$e():a.indexOf("tree")>-1?Be():a.indexOf("backgrounds")>-1?Ae():a.indexOf("images")>-1&&Fe(),K(I.btnBack,f.currentHistoryIndex===0),K(I.btnNext,f.currentHistoryIndex===f.history.length-1),f.devMode){const n=performance.now()-e;document.getElementById("update-time").textContent=`${n.toFixed(3)}ms`}}function Me(){const e=f.currentHistoryIndex+1;e>=f.history.length||(w.currentDialogueID=f.history[e],f.currentHistoryIndex++)}function He(){const e=f.currentHistoryIndex-1;e<0||(w.currentDialogueID=f.history[e],f.currentHistoryIndex--)}function se(e){f.currentHistoryIndex<f.history.length-1&&(f.history.length=f.currentHistoryIndex+1),w.currentDialogueID=e,f.history.push(e),f.currentHistoryIndex++}function Ve(){((i,a,n)=>{ge(i,a,(t,c)=>{setTimeout(()=>{n(t,c)},0)})})("div#choices button.choice","click",i=>{se(w.currentDialogueID),$()})}function k(){setTimeout(()=>{he(),$()},0)}const le=[];let ue=!1;function p(e,i,a){ue||qe(),Array.isArray(i)||(i=[i]);for(const n of i)le.push({selector:e,eventName:n,handler:a})}function qe(){document.body.addEventListener("click",L.bind(null,"click")),document.body.addEventListener("input",L.bind(null,"input")),document.body.addEventListener("change",L.bind(null,"change")),document.body.addEventListener("contextmenu",L.bind(null,"contextmenu")),document.body.addEventListener("keyup",L.bind(null,"keyup")),document.body.addEventListener("focusout",L.bind(null,"focusout")),document.body.addEventListener("mouseover",L.bind(null,"mouseover")),document.body.addEventListener("mousemove",L.bind(null,"mousemove")),document.body.addEventListener("mouseout",L.bind(null,"mouseout")),ue=!0}function L(e,i){const a=i.target;for(const n of le)n.eventName===e&&a.matches(n.selector)&&n.handler(i,a);i.stopImmediatePropagation()}function q(e){switch(e){case"backgrounds":return m.backgrounds[0];case"images":return m.images[0];case"characters":return m.characters[0]}}function Pe(e){const i=b("choices",e);m.choices.splice(m.choices.indexOf(i),1);for(const n of m.dialogue)n.choices.indexOf(e)>-1&&n.choices.splice(n.choices.indexOf(e),1);const a=f.tree.collapsed.choices.indexOf(i.id);a>-1&&f.tree.collapsed.choices.splice(a,1)}function Re(e){const i=b("characters",e);m.characters.splice(m.characters.indexOf(i),1);const a=q("characters");for(const n of m.dialogue)n.character1ID===e&&(n.character1ID=a.id,n.character1FrameIndex=0),n.character2ID===e&&(n.character2ID=a.id,n.character2FrameIndex=0)}function We(e){const i=b("backgrounds",e);m.backgrounds.splice(m.backgrounds.indexOf(i),1);const a=m.backgrounds[0].id;for(const n of m.dialogue)n.backgroundID===e&&(n.backgroundID=a)}function _e(e){const i=b("images",e);m.images.splice(m.images.indexOf(i),1);const a=m.images[0].id;for(const n of m.backgrounds)n.imageID===e&&(n.imageID=a);for(const n of m.frames)n.imageID===e&&(n.imageID=a)}function je(e){const i=b("dialogue",e);m.dialogue.splice(m.dialogue.indexOf(i),1)}function ze(e){const i=b("frames",e),a=[];let n=!1;for(const t of m.characters){const c=t.frames.indexOf(e);if(c===0){n=!0;break}else c>0&&a.push(t)}if(!n){for(const t of a)t.frames.splice(t.frames.indexOf(e),1);m.frames.splice(m.frames.indexOf(i),1)}}const A={choice:Pe,character:Re,background:We,image:_e,dialogue:je,frame:ze},P={};(()=>{const e=Object.keys(m);e.splice(e.indexOf("meta"),1);for(const i of e)P[i]=[]})();function B(e){let i=Math.floor(Math.random()*9999999999);return P[e].indexOf(i)>-1&&(i=B(e)),P[e].push(i),i}function Ue(){const e=Object.keys(P);for(const i of e)for(const a of m[i])P[i].push(a.id)}function Ge(e){console.log(e);const i={id:B("dialogue"),text:"Dialogue text",choices:[],backgroundID:N(e.backgroundID,q("backgrounds").id),character1ID:N(e.character1ID,q("characters").id),character1FrameIndex:N(e.character1FrameIndex,0),character2ID:N(e.character2ID,null),character2FrameIndex:N(e.character2FrameIndex,null),ownerCharacterID:N(e.ownerCharacterID,q("characters").id)};return m.dialogue.push(i),i}function Xe(){const e={id:B("choices"),text:"Choice text",targetDialogueID:null};return m.choices.push(e),e}function Je(){const e=de(),i={id:B("characters"),name:"New Character",frames:[e.id]};return m.characters.push(i),i}function de(e){const i={id:B("frames"),name:e||"Default frame",imageID:q("images").id};return m.frames.push(i),i}function Ke(){const e={id:B("images"),name:"New Image",filename:""};return m.images.push(e),e}const F={dialogue:Ge,choice:Xe,character:Je,frame:de,image:Ke};function Qe(){const e="#dialogue-tab";p(`${e} textarea.dialogue`,"input",(i,a)=>{const n=b("dialogue",w.currentDialogueID);n.text=a.value,k()}),p(`${e} div.choices textarea.text`,"input",(i,a)=>{const n=+a.closest("div.choice").dataset.id,t=b("choices",n);t.text=a.value,k()}),p(`${e} div.choices button.create`,"click",()=>{const i=b("dialogue",w.currentDialogueID),a=F.choice();i.choices.push(a.id),k()}),p(`${e} div.choices button.delete`,"click",(i,a)=>{const n=+a.closest("div.choice").dataset.id;A.choice(n),k()}),p(`${e} div.choices button.create-dialogue`,"click",(i,a)=>{const n=b("dialogue",w.currentDialogueID),t=+a.closest("div.choice").dataset.id,c=b("choices",t),o=F.dialogue(n);c.targetDialogueID=o.id,k()}),p(`${e} div.choices button.go-to-dialogue`,"click",(i,a)=>{const n=+a.closest("div.choice").dataset.id,t=b("choices",n);w.currentDialogueID!==t.targetDialogueID&&(w.currentDialogueID=t.targetDialogueID,k())}),p(`${e} div.characters .character select.name`,"click",(i,a)=>{const n=a.closest("div.character").matches(":first-of-type"),t=b("dialogue",w.currentDialogueID),c=+a.closest("div.character").dataset.id,o=a.value;let g,r;if(o==="none"?(g=null,r=null):(g=+o,r=0),g!==null&&(n&&g===t.character2ID||!n&&g===t.character1ID)){const u=n?t.character1ID:t.character2ID;a.value=u===null?"none":u.toString();return}g!==null&&t.ownerCharacterID===null&&t.character1ID===null&&t.character2ID===null&&(t.ownerCharacterID=g),n?(t.character1ID=g,t.character1FrameIndex=r):(t.character2ID=g,t.character2FrameIndex=r),o==="none"&&c===t.ownerCharacterID&&(t.ownerCharacterID=null),o==="none"&&t.ownerCharacterID===null&&(t.character1ID!==null||t.character2ID!==null)&&(t.character1ID!==null?t.ownerCharacterID=t.character1ID:t.character2ID!==null&&(t.ownerCharacterID=t.character2ID)),k()}),p(`${e} div.characters .character select.frame`,"click",(i,a)=>{const n=a.closest("div.character").matches(":first-of-type"),t=b("dialogue",w.currentDialogueID),c=a.value;let o;c==="none"?o=null:o=+c,n?t.character1FrameIndex=o:t.character2FrameIndex=o,k()}),p(`${e} div.characters .character input.owner`,"change",(i,a)=>{const n=b("dialogue",w.currentDialogueID),t=a.closest(".character").dataset.id;n.ownerCharacterID=t==="none"?null:+t,k()}),p(`${e} select.background`,"click",(i,a)=>{const n=b("dialogue",w.currentDialogueID),t=+a.value;n.backgroundID=t,k()})}function Ye(){const e="#characters-tab";p(`${e} button.create`,"click",()=>{F.character(),$()}),p(`${e} div.character > button.delete`,"click",(i,a)=>{const n=+a.closest("div.character").dataset.id;A.character(n),k()}),p(`${e} div.character > input.name`,"input",(i,a)=>{const n=+a.closest("div.character").dataset.id,t=b("characters",n);t.name=a.value,k()}),p(`${e} div.frame > button.create`,"click",(i,a)=>{const n=+a.closest("div.character").dataset.id,t=b("characters",n),c=F.frame("New frame");t.frames.push(c.id),k()}),p(`${e} div.frame > input.name`,"input",(i,a)=>{const n=+a.closest("div.frame").dataset.id,t=b("frames",n);t.name=a.value,k()}),p(`${e} div.frame > select.image`,"change",(i,a)=>{const n=+a.closest("div.frame").dataset.id,t=+a.value,c=b("frames",n);c.imageID=t,k()}),p(`${e} div.frame > button.delete`,"click",(i,a)=>{const n=+a.closest("div.frame").dataset.id;A.frame(n),k()})}function Ze(){const e="#backgrounds-tab";p(`${e} button.create`,"click",()=>{const i=B("backgrounds");m.backgrounds.push({id:i,name:"New Background",imageID:m.images[0].id,bgColor:"#FFFFFF"}),$()}),p(`${e} .list button.delete`,"click",(i,a)=>{const n=+a.closest("div.background").dataset.id;A.background(n),k()}),p(`${e} .list input.name`,"input",(i,a)=>{const n=+a.closest("div.background").dataset.id,t=b("backgrounds",n);t.name=a.value,k()}),p(`${e} .list input.bg-color`,"change",(i,a)=>{const n=+a.closest("div.background").dataset.id,t=b("backgrounds",n);let c=a.value;c.indexOf("#")===-1&&(c="#"+c),t.bgColor=c,k()}),p(`${e} .list select.image`,"change",(i,a)=>{const n=+a.closest("div.background").dataset.id,t=+a.value,c=b("backgrounds",n);c.imageID=t,k()})}function et(){const e="#images-tab";p(`${e} button.create`,"click",()=>{F.image(),$()}),p(`${e} .list button.delete`,"click",(n,t)=>{const c=+t.closest("div.image").dataset.id;A.image(c),k()}),p(`${e} .list input.name`,"input",(n,t)=>{const c=+t.closest("div.image").dataset.id,o=b("images",c);o.name=t.value,$()}),p(`${e} .list select.image-file`,"change",(n,t)=>{const c=+t.closest("div.image").dataset.id,o=b("images",c);o.filename=t.value,k()}),p(`${e} select.image-file-preview-select`,"change",(n,t)=>{let c=t.value;c==="none"?c="":c="/assets/images/"+c,I.imagesTab.previewImage.src=c}),p(`${e} #upload button.submit`,"click",async()=>{if(I.imagesTab.fileInput.files.length===0){i();return}const n=I.imagesTab.fileInput.files[0];let t=I.imagesTab.uploadFileName.value;t||(t=n.name),t=encodeURIComponent(t);const c="/api/upload-image?filename="+t,o=await fetch(c,{method:"POST",body:n.slice()}),g=await o.text();if(o.status!==200)console.log(o),i();else{a();const r=F.image();r.name=t.replace(".png",""),r.filename=g}$()});function i(){I.imagesTab.uploadButton.classList.add("error"),I.imagesTab.uploadButton.disabled=!0,setTimeout(()=>{I.imagesTab.uploadButton.classList.remove("error"),I.imagesTab.uploadButton.disabled=!1},1500)}function a(){I.imagesTab.uploadButton.classList.add("success"),I.imagesTab.uploadButton.disabled=!0,setTimeout(()=>{I.imagesTab.uploadButton.classList.remove("success"),I.imagesTab.uploadButton.disabled=!1},1500)}}function tt(){const e="#tree-tab";p(`${e} li > div.content > span.text`,"click",(n,t)=>{const c=t.closest("li"),o=c.classList.toggle("collapsed"),g=+c.dataset.id,u=/dialogue/i.test(c.className)?f.tree.collapsed.dialogue:f.tree.collapsed.choices;o?u.push(g):u.splice(u.indexOf(g),1)}),p(`${e} li.dialogue > div.content > button.go-to`,"click",(n,t)=>{const c=+t.closest("li.dialogue").dataset.id;w.currentDialogueID!==c&&(w.currentDialogueID=c,se(c),k())}),p(`${e} li.dialogue.reference > div.content > span.text`,"mouseover",(n,t)=>{const c=+t.closest("li.dialogue").dataset.id;y(`${e} li.dialogue:not(.reference)[data-id="${c}"]`).classList.add("highlight")}),p(`${e} li.dialogue.reference > div.content > span.text`,"mouseout",(n,t)=>{y(`${e} li.dialogue:not(.reference).highlight`).classList.remove("highlight")}),p(`${e} li.dialogue > div.content > button.link`,"click",(n,t)=>{f.tree.linking.finalized&&i();const c=+t.closest("li.dialogue").dataset.id;f.tree.linking.dialogueID===c?f.tree.linking.dialogueID=null:f.tree.linking.dialogueID=c,a()}),p(`${e} li.choice > div.content > button.link`,"click",(n,t)=>{f.tree.linking.finalized&&i();const c=+t.closest("li.choice").dataset.id,o=b("choices",c);f.tree.linking.choiceID===c?(f.tree.linking.choiceID=null,f.tree.linking.srcDialogueID=null):(f.tree.linking.choiceID=c,o.targetDialogueID!==null&&(f.tree.linking.srcDialogueID=o.targetDialogueID)),a()});function i(){f.tree.linking.choiceID=null,f.tree.linking.dialogueID=null,f.tree.linking.srcDialogueID=null}function a(){if(f.tree.linking.choiceID===null||f.tree.linking.dialogueID===null){f.tree.linking.finalized=!1,$();return}const n=b("choices",f.tree.linking.choiceID);n.targetDialogueID=f.tree.linking.dialogueID,f.tree.linking.finalized=!0,k()}p(`${e} > div > button.undo`,"click",(n,t)=>{const c=Object.assign({},f.tree.linking);f.tree.linking.dialogueID=c.srcDialogueID,f.tree.linking.srcDialogueID=c.dialogueID;const o=b("choices",c.choiceID);o.targetDialogueID=c.srcDialogueID,k()}),p(`${e} li.choice > div.content > button.unlink`,"click",(n,t)=>{const c=+t.closest("li.choice").dataset.id,o=b("choices",c);o.targetDialogueID=null,k()}),p(`${e} li.choice > div.content > button.create-dialogue`,"click",(n,t)=>{const c=+t.closest("li.dialogue").dataset.id,o=+t.closest("li.choice").dataset.id,g=b("dialogue",c),r=b("choices",o),u=F.dialogue(g);r.targetDialogueID=u.id,k()})}function nt(){const e="#utilities-tab";p(`${e} button.remove-orphans`,"click",()=>{const i=m.dialogue.map(n=>n.id);i.splice(0,1);for(const n of m.choices){const t=i.indexOf(n.targetDialogueID);t>-1&&i.splice(t,1)}for(const n of i)A.dialogue(n);const a=m.choices.map(n=>n.id);for(const n of m.dialogue)for(const t of n.choices){const c=a.indexOf(t);c>-1&&a.splice(c,1)}for(const n of a)A.choice(n)}),p(`${e} button.reset-everything`,"click",async()=>{confirm("Are you sure you want to reset everything? This cannot be undone.")&&(localStorage.clear(),navigator.serviceWorker.controller.postMessage("clear-idb"))})}function at(){Qe(),Ye(),Ze(),et(),tt(),nt(),p("button#nav-back","click",()=>{He(),k()}),p("button#nav-next","click",()=>{Me(),k()}),p("button#game-size","click",(a,n)=>{const t=document.querySelector("iframe"),c=document.getElementById("editor");c.classList.contains("hidden")?(t.style.width="",c.classList.remove("hidden"),n.innerHTML="&gt;"):(t.style.width="100%",c.classList.add("hidden"),n.innerHTML="&lt;")}),p("button#push","click",async(a,n)=>{n.classList.add("active"),n.disabled=!0,n.textContent="Pushing...";const t=Object.keys(m);for(const c of t)await fetch("/api/save",{method:"post",body:JSON.stringify({type:c,data:m[c]})});n.classList.remove("active"),n.textContent="Pushed",setTimeout(()=>{n.disabled=!1,n.textContent="Push changes"},750)}),p("button#save","click",async(a,n)=>{i(n)});let e=!1;p("button#clear","click",async(a,n)=>{e=!0;const t=localStorage.getItem("editor-opened-tab");localStorage.clear(),t&&localStorage.setItem("editor-opened-tab",t),n.textContent="Cleared",setTimeout(()=>{location.reload()},500)}),setInterval(i.bind(null,I.btnSave,!0),15e3),window.addEventListener("beforeunload",i.bind(null,I.btnSave,!0));function i(a,n){if(n&&e)return;const t=Object.keys(m);for(const c of t)localStorage.setItem("editor-"+c,JSON.stringify(m[c]));a.disabled=!0,a.textContent="Saved",setTimeout(()=>{a.disabled=!1,a.textContent="Save"},2500)}}const it=document.getElementById("tabs-list");function ct(){const e=localStorage.getItem("editor-opened-tab");e&&setTimeout(()=>{const i=y(`#tabs-list span.link[data-target="${e}"]`);i&&i.click()},0),p("#tabs-list span.link","click",(i,a)=>{document.querySelector(".tab.active").classList.remove("active"),it.querySelector(".active").classList.remove("active");const n=a.dataset.target+"-tab";document.getElementById(n).classList.add("active"),a.classList.add("active"),localStorage.setItem("editor-opened-tab",a.dataset.target),$()})}async function ot(){const e=Object.keys(m),i={};let a=!1;for(const t of e){const c=localStorage.getItem("editor-"+t);c||(a=!0),i[t]=JSON.parse(c)}const n=f.devMode;a||n?(console.log("Allowing game to load data..."),await me()):(Object.assign(m,i),console.log("Loaded data from local storage.")),console.log("Game data:",m),window.data=m}function ie(e,i){const a=pe(e),n=i+1;switch(n){case 2:{for(const t of a.dialogue)t.ownerCharacterID=t.characterID,ce(t,"characterID","character1ID"),ce(t,"characterFrameIndex","character1FrameIndex"),t.character2ID=null,t.character2FrameIndex=null;break}case 1:{if(a.meta={version:1},a.frames)break;a.frames=[];let t=0;for(const c of a.characters){const o={id:t++,name:"Default frame",imageID:c.imageID};a.frames.push(o),c.frames=[o.id],delete c.imageID}for(const c of a.dialogue)c.characterFrameIndex=0;break}}return a.meta.version=n,a}function ce(e,i,a){const n=e[i];delete e[i],e[a]=n}const J=2;function rt(e){const i=st(e);if(i>J)throw new Error("Game Data version is newer than expected. Please go back in time and try again.");if(i===J)return e;let a=ie(e,i);for(;a.meta.version<J;)a=ie(a,a.meta.version);return a}function st(e){return e.meta?e.meta.version:0}const lt=["editor-opened-tab"];function ut(){const e={},i=[];for(let t=0;t<localStorage.length;t++){const c=localStorage.key(t);lt.indexOf(c)>-1||i.push(c)}if(i.length===0)return;for(const t of i)try{const c=JSON.parse(localStorage.getItem(t)),o=t.replace("editor-","");e[o]=c}catch{return}const a=rt(e);if(console.log("Migrated local data to new version. Saving..."),a===e)return;const n=Object.keys(a);for(const t of n){const c="editor-"+t,o=JSON.stringify(a[t]);localStorage.setItem(c,o)}console.log("Saved.")}var dt=function(){return!!(window.location.hostname==="localhost"||window.location.hostname==="[::1]"||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/))},Q;typeof window<"u"&&(typeof Promise<"u"?Q=new Promise(function(e){return window.addEventListener("load",e)}):Q={then:function(e){return window.addEventListener("load",e)}});function ft(e,i){i===void 0&&(i={});var a=i.registrationOptions;a===void 0&&(a={}),delete i.registrationOptions;var n=function(t){for(var c=[],o=arguments.length-1;o-- >0;)c[o]=arguments[o+1];i&&i[t]&&i[t].apply(i,c)};"serviceWorker"in navigator&&Q.then(function(){dt()?(gt(e,n,a),navigator.serviceWorker.ready.then(function(t){n("ready",t)}).catch(function(t){return R(n,t)})):(fe(e,n,a),navigator.serviceWorker.ready.then(function(t){n("ready",t)}).catch(function(t){return R(n,t)}))})}function R(e,i){navigator.onLine||e("offline"),e("error",i)}function fe(e,i,a){navigator.serviceWorker.register(e,a).then(function(n){if(i("registered",n),n.waiting){i("updated",n);return}n.onupdatefound=function(){i("updatefound",n);var t=n.installing;t.onstatechange=function(){t.state==="installed"&&(navigator.serviceWorker.controller?i("updated",n):i("cached",n))}}}).catch(function(n){return R(i,n)})}function gt(e,i,a){fetch(e).then(function(n){n.status===404?(i("error",new Error("Service worker not found at "+e)),oe()):n.headers.get("content-type").indexOf("javascript")===-1?(i("error",new Error("Expected "+e+" to have javascript content-type, but received "+n.headers.get("content-type"))),oe()):fe(e,i,a)}).catch(function(n){return R(i,n)})}function oe(){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()}).catch(function(e){return R(emit,e)})}function ht(){return new Promise((e,i)=>{const a=console.log.bind(console),n=console.error.bind(console);ft(be("./service-worker.js"),{registrationOptions:{scope:"./",type:"module"},registered(t){a("Service worker has been registered.")},ready(t){a("Service worker is active."),e()},cached(t){a("Content has been cached for offline use.")},updatefound(t){a("New content is downloading.")},updated(t){a("New content is available; please refresh.")},offline(){a("No internet connection found. App is running in offline mode.")},error(t){n("Error during service worker registration:",t),i()}})})}window.addEventListener("load",async()=>{if(window!==window.top)return;await ht(),ut(),await ot(),Ue(),w.currentDialogueID=0,f.history.push(0),f.currentHistoryIndex=0,ve(),Ve(),Ie(),at(),ct(),k();const e=await(await fetch("/api/version")).text();document.getElementById("version").textContent="v"+e,f.devMode&&document.getElementById("update-time").classList.remove("hidden")});
